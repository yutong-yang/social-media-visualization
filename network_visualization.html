<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾äº¤åª’ä½“ä¼ æ’­ç½‘ç»œå¯è§†åŒ–</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: bold;
            font-size: 12px;
            color: #555;
        }
        
        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .control-btn.active {
            background: #2196F3;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-controls input, .filter-controls select {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .filter-controls label {
            font-size: 12px;
            color: #555;
        }
        

        
        .legend {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            display: inline-block;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .legend-line {
            display: inline-block;
            margin-right: 8px;
            border-radius: 1px;
        }
        
        #network-container {
            width: 100%;
            height: 700px;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: relative;
            background: #fafafa;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
        }
        
        .performance-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .evolution-tree {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .tree-node {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tree-node:hover {
            transform: scale(1.5);
        }
        

        
        .tree-link {
            position: absolute;
            background: #ccc;
            height: 1px;
            transform-origin: left center;
        }
        
        .tree-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
        }
        
        .time-arrow {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 16px;
            color: #666;
            z-index: 100;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .control-group h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        
        .query-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .query-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .query-btn {
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .query-btn:hover {
            background: #45a049;
        }
        
        .query-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border-radius: 4px;
            padding: 8px;
        }
        
        .query-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .query-result {
            background: white;
            padding: 6px;
            margin-bottom: 4px;
            border-radius: 3px;
            border-left: 3px solid #4CAF50;
            font-size: 11px;
        }
        
        .query-result strong {
            color: #333;
        }
        
        .query-result small {
            color: #666;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            padding: 8px 16px;
            background: white;
            color: #555;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            /* border: 1px solid #6aaeae5b; */
        }

        .nav-link:hover {
            background: #99999937;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="background: #f8f9fa; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0; color: #333;">ç¤¾äº¤åª’ä½“ä¼ æ’­ç½‘ç»œå¯è§†åŒ–</h1>
            <nav style="display: flex; gap: 15px;">
                 <a href="index.html" class="nav-link">ğŸ  ä¸»é¡µ</a>
                <a href="data_visualization.html" class="nav-link">ğŸ“ˆ æ•°æ®åˆ†æ</a>
            </nav>
        </header>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls-panel">
            <!-- è§†å›¾ç±»å‹ -->
            <div class="control-group">
                <h4>è§†å›¾ç±»å‹</h4>
                <button class="control-btn active" onclick="showView('all')">å…¨éƒ¨</button>
                <button class="control-btn" onclick="showView('user-post')">ç”¨æˆ·-å¸–å­</button>
                <button class="control-btn" onclick="showView('post-platform')">å¸–å­-å¹³å°</button>
                <button class="control-btn" onclick="showView('post-spread')">ä¼ æ’­å…³ç³»</button>
            </div>
            
            <!-- ä¼ æ’­å¼ºåº¦è¿‡æ»¤ -->
            <div class="control-group">
                <h4>ä¼ æ’­å¼ºåº¦è¿‡æ»¤</h4>
                <input type="range" id="weight-slider" min="0" max="0.22" step="0.01" value="0" class="slider">
                <span id="weight-value">0.00</span>
            </div>
            
            <!-- èŠ‚ç‚¹ç±»å‹è¿‡æ»¤ -->
            <div class="control-group">
                <h4>èŠ‚ç‚¹ç±»å‹è¿‡æ»¤</h4>
                <label><input type="checkbox" id="show-users" checked> ç”¨æˆ·</label>
                <label><input type="checkbox" id="show-posts" checked> å¸–å­</label>
                <label><input type="checkbox" id="show-platforms" checked> å¹³å°</label>
            </div>
            
            <!-- æ˜¾ç¤ºé€‰é¡¹ -->
            <div class="control-group">
                <h4>æ˜¾ç¤ºé€‰é¡¹</h4>
                <label><input type="checkbox" id="show-labels"> æ˜¾ç¤ºæ ‡ç­¾</label>
                <label><input type="checkbox" id="show-weights"> æ˜¾ç¤ºæƒé‡</label>
            </div>
            
            <!-- å¸ƒå±€æ§åˆ¶ -->
            <div class="control-group">
                <h4>å¸ƒå±€æ§åˆ¶</h4>
                <button onclick="resetLayout()" class="control-btn">é‡ç½®å¸ƒå±€</button>
                <button id="pause-btn" onclick="toggleSimulation()" class="control-btn">æš‚åœ</button>
            </div>
            
            <!-- æ•°æ®è¿‡æ»¤ -->
            <div class="control-group">
                <h4>æ•°æ®è¿‡æ»¤</h4>
                <label><input type="checkbox" id="enable-path-filter" checked> å¯ç”¨è·¯å¾„è¿‡æ»¤</label>
                <button onclick="togglePathFilter()" class="control-btn">åˆ‡æ¢è¿‡æ»¤</button>
            </div>
            
            <!-- ç½‘ç»œä¿¡æ¯ -->
            <div class="control-group">
                <h4>ç½‘ç»œä¿¡æ¯</h4>
                <div id="network-info" style="font-size: 11px; line-height: 1.3; color: #666;">
                    <div>èŠ‚ç‚¹æ•°: <span id="node-count">-</span></div>
                    <div>è¾¹æ•°: <span id="edge-count">-</span></div>
                    <div>å½“å‰è§†å›¾: <span id="current-view">-</span></div>
                    <div>ç”¨æˆ·èŠ‚ç‚¹: <span id="user-count">-</span></div>
                    <div>å¸–æ–‡èŠ‚ç‚¹: <span id="post-count">-</span></div>
                    <div>å¹³å°èŠ‚ç‚¹: <span id="platform-count">-</span></div>
                    <div>ä¼ æ’­å¼ºåº¦é˜ˆå€¼: <span id="threshold-display">0.000</span></div>
                </div>
            </div>
            
            <!-- èšåˆæ¨¡å¼ -->
            <!-- <div class="control-group">
                <h4>èšåˆæ¨¡å¼</h4>
                <button class="control-btn active" onclick="setAggregationMode('none')">æ— èšåˆ</button>
                <button class="control-btn" onclick="setAggregationMode('community')">ç¤¾åŒºèšåˆ</button>
                <button class="control-btn" onclick="setAggregationMode('platform')">å¹³å°èšåˆ</button>
                <button class="control-btn" onclick="setAggregationMode('user')">ç”¨æˆ·èšåˆ</button>
                <button class="control-btn" onclick="setAggregationMode('simple')">ç®€å•èšåˆ</button>
            </div> -->
        </div>
        
        <div style="display: flex; gap: 20px;">
            <div id="network-container" style="flex: 2;">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div id="evolution-tree-container" style="flex: 1; height: 600px; border: 0px solid #ddd; border-radius: 5px; position: relative;">
                    <div class="loading">åŠ è½½æ¼”åŒ–æ ‘...</div>
                </div>
                <div id="topic-legend" style="height: 40px; position: relative; background: #f0f0f0; border: 1px solid #ddd; border-top: none; font-size: 11px; padding: 5px;">
                    <!-- è¯é¢˜å›¾ä¾‹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="legend">
            <!-- èŠ‚ç‚¹ç±»å‹å›¾ä¾‹ -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">èŠ‚ç‚¹ç±»å‹</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #ff6b6b; width: 10px; height: 10px;"></span>
                        ç”¨æˆ·èŠ‚ç‚¹ (å°)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4ecdc4; width: 8px; height: 8px;"></span>
                        å¸–æ–‡èŠ‚ç‚¹ (å°)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #45b7d1; width: 20px; height: 20px;"></span>
                        å¹³å°èŠ‚ç‚¹ (å¤§)
                    </div>
                </div>
            </div>
            
            <!-- å¹³å°é¢œè‰²å›¾ä¾‹ -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">å¹³å°é¢œè‰²</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4A90E2; width: 15px; height: 15px;"></span>
                        å¾®åš
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #C3AB32; width: 15px; height: 15px;"></span>
                        ç½‘æ˜“æ–°é—»
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #AC6158; width: 15px; height: 15px;"></span>
                        æŠ–éŸ³
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #AD748C; width: 15px; height: 15px;"></span>
                        ä»Šæ—¥å¤´æ¡
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #3E5555; width: 15px; height: 15px;"></span>
                        å°çº¢ä¹¦
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #E17D66; width: 15px; height: 15px;"></span>
                        å¾®ä¿¡
                    </div>
                </div>
            </div>
            
            <!-- è¾¹ç±»å‹å›¾ä¾‹ -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">å…³ç³»ç±»å‹</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-line" style="background: #ff6b6b; width: 20px; height: 2px;"></span>
                        ç”¨æˆ·-å¸–æ–‡å…³ç³»
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #45b7d1; width: 20px; height: 2px;"></span>
                        å¸–æ–‡-å¹³å°å…³ç³»
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 20px; height: 2px;"></span>
                        ä¼ æ’­å…³ç³»
                    </div>
                </div>
            </div>
            
            <!-- ä¼ æ’­å¼ºåº¦å›¾ä¾‹ -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ä¼ æ’­å¼ºåº¦</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 1px;"></span>
                        å¼±ä¼ æ’­
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 3px;"></span>
                        ä¸­ç­‰ä¼ æ’­
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 6px;"></span>
                        å¼ºä¼ æ’­
                    </div>
                </div>
            </div>
        </div>
        

        
        <div class="performance-info" id="performance-info">
            æ€§èƒ½ä¿¡æ¯
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let networkData = null;
        let simulation = null;
        let svg = null;
        let currentView = 'all';
        let allNodes = [];
        let allLinks = [];
        let filteredNodes = [];
        let filteredLinks = [];
        let tooltip = null;
        let isSimulationRunning = true;
        
        // æ¼”åŒ–æ ‘ç›¸å…³å˜é‡
        let evolutionData = null;
        let treeContainer = null;
        let treeTooltip = null;
        
        // è¿‡æ»¤è®¾ç½®
        let weightThreshold = 0;
        let showUsers = true;
        let showPosts = true;
        let showPlatforms = true;
        let showLabels = false;
        let showWeights = false;
        
        // èšåˆè®¾ç½®
        // let aggregationMode = 'none'; // 'none', 'community', 'platform', 'user'
        // let aggregatedNodes = new Map();
        // let aggregatedLinks = [];
        
        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // é¦–å…ˆåŠ è½½è·¯å¾„æ•°æ®
                const pathsResponse = await fetch('./data/4-1data/paths_data.json');
                const pathsData = await pathsResponse.json();
                console.log('è·¯å¾„æ•°æ®åŠ è½½æˆåŠŸ:', pathsData);
                
                // æå–æ‰€æœ‰è·¯å¾„ä¸­çš„å¸–æ–‡ID
                const pathPostIds = new Set();
                pathsData.forEach(path => {
                    if (path.è·¯å¾„ && Array.isArray(path.è·¯å¾„)) {
                        path.è·¯å¾„.forEach(post => {
                            if (post.å¸–æ–‡ID) {
                                pathPostIds.add(post.å¸–æ–‡ID);
                            }
                        });
                    }
                });
                
                console.log('ä»è·¯å¾„æ•°æ®ä¸­æå–çš„å¸–æ–‡IDæ•°é‡:', pathPostIds.size);
                console.log('è·¯å¾„å¸–æ–‡IDç¤ºä¾‹:', Array.from(pathPostIds).slice(0, 5));
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                window.pathPostIds = pathPostIds;
                
                // åˆå§‹åŒ–æ¼”åŒ–æ ‘
                initializeEvolutionTree();
                
                // å¤„ç†æ¼”åŒ–æ•°æ®
                evolutionData = processEvolutionData(pathsData);
                console.log('æ¼”åŒ–æ•°æ®å¤„ç†å®Œæˆ:', {
                    totalPosts: evolutionData.posts.length,
                    totalTopics: evolutionData.topics.size
                });
                
                // ç»˜åˆ¶æ¼”åŒ–æ ‘
                drawEvolutionTree(evolutionData);
                
                // ç”Ÿæˆè¯é¢˜å›¾ä¾‹
                generateTopicLegend(evolutionData);
                

                
                // åŠ è½½ç½‘ç»œæ•°æ®
                const response = await fetch('./data/4-1data/edge_data_complete.json');
                networkData = await response.json();
                console.log('ç½‘ç»œæ•°æ®åŠ è½½æˆåŠŸ:', networkData);
                
                // ä¼ é€’è·¯å¾„å¸–æ–‡IDè¿›è¡Œè¿‡æ»¤
                processAllData(pathPostIds);
                initializeVisualization();
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('network-info').innerHTML = 'æ•°æ®åŠ è½½å¤±è´¥';
            }
        }
        
        // å¤„ç†æ‰€æœ‰æ•°æ®
        function processAllData(pathPostIds) {
            const nodes = new Map();
            const links = [];
            
            // å¤„ç†æ‰€æœ‰è¾¹ç±»å‹
            const edgeTypes = {
                'user-post': networkData.edge_index_dict["('user', 'posted', 'post')"],
                'post-platform': networkData.edge_index_dict["('post', 'on_platform', 'platform')"],
                'post-spread': networkData.edge_index_dict["('post', 'spread_to', 'post')"]
            };
            
            const edgeAttrs = {
                'user-post': networkData.edge_attr_dict["('user', 'posted', 'post')"],
                'post-platform': networkData.edge_attr_dict["('post', 'on_platform', 'platform')"],
                'post-spread': networkData.edge_attr_dict["('post', 'spread_to', 'post')"]
            };
            
            console.log('å¼€å§‹å¤„ç†æ•°æ®:', {
                edgeTypes: Object.keys(edgeTypes),
                userPostEdges: edgeTypes['user-post'] ? edgeTypes['user-post'].length : 0,
                postPlatformEdges: edgeTypes['post-platform'] ? edgeTypes['post-platform'].length : 0,
                postSpreadEdges: edgeTypes['post-spread'] ? edgeTypes['post-spread'].length : 0,
                pathPostIdsCount: pathPostIds.size
            });
            
            // å¤„ç†æ¯ç§è¾¹ç±»å‹
            Object.keys(edgeTypes).forEach(type => {
                const edges = edgeTypes[type];
                const attrs = edgeAttrs[type];
                
                if (edges && edges.length >= 2) {
                    // ç¬¬ä¸€ä¸ªæ•°ç»„æ˜¯æºèŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªæ•°ç»„æ˜¯ç›®æ ‡èŠ‚ç‚¹
                    const sources = edges[0];
                    const targets = edges[1];
                    
                    console.log(`å¤„ç† ${type} è¾¹:`, {
                        sourcesLength: sources.length,
                        targetsLength: targets.length,
                        attrsLength: attrs ? attrs.length : 0
                    });
                    
                    for (let i = 0; i < Math.min(sources.length, targets.length); i++) {
                        const source = sources[i];
                        const target = targets[i];
                        const weight = attrs[i] || 1;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«è·¯å¾„ä¸­çš„å¸–æ–‡ID
                        let shouldInclude = false;
                        
                        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è·¯å¾„è¿‡æ»¤
                        const enableFilter = document.getElementById('enable-path-filter').checked;
                        
                        if (!enableFilter || pathPostIds.size === 0) {
                            // ä¸å¯ç”¨è¿‡æ»¤æˆ–è·¯å¾„æ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                            shouldInclude = true;
                        } else {
                            // å¯ç”¨è·¯å¾„è¿‡æ»¤
                            if (type === 'user-post') {
                                // ç”¨æˆ·-å¸–å­å…³ç³»ï¼šæ£€æŸ¥å¸–å­æ˜¯å¦åœ¨è·¯å¾„ä¸­
                                if (pathPostIds.has(target)) {
                                    shouldInclude = true;
                                    // console.log(`åŒ…å«è·¯å¾„å¸–æ–‡: ${target} (ç”¨æˆ·-å¸–å­å…³ç³»)`);
                                }
                            } else if (type === 'post-platform') {
                                // å¸–å­-å¹³å°å…³ç³»ï¼šæ£€æŸ¥å¸–å­æ˜¯å¦åœ¨è·¯å¾„ä¸­
                                if (pathPostIds.has(source)) {
                                    shouldInclude = true;
                                    // console.log(`åŒ…å«è·¯å¾„å¸–æ–‡: ${source} (å¸–å­-å¹³å°å…³ç³»)`);
                                }
                            } else if (type === 'post-spread') {
                                // å¸–å­ä¼ æ’­å…³ç³»ï¼šæ£€æŸ¥æºå¸–å­æˆ–ç›®æ ‡å¸–å­æ˜¯å¦åœ¨è·¯å¾„ä¸­
                                if (pathPostIds.has(source) || pathPostIds.has(target)) {
                                    shouldInclude = true;
                                    // console.log(`åŒ…å«è·¯å¾„å¸–æ–‡: ${source} -> ${target} (å¸–å­ä¼ æ’­å…³ç³»)`);
                                }
                            }
                        }
                        
                        // å¦‚æœåŒ…å«è·¯å¾„ä¸­çš„å¸–æ–‡ï¼Œåˆ™æ·»åŠ èŠ‚ç‚¹å’Œè¾¹
                        if (shouldInclude) {
                            // æ·»åŠ èŠ‚ç‚¹
                            if (!nodes.has(source)) {
                                nodes.set(source, createNode(source));
                            }
                            if (!nodes.has(target)) {
                                nodes.set(target, createNode(target));
                            }
                            
                            // æ·»åŠ è¾¹
                            let linkColor = getLinkColor(type);
                            
                            // å¦‚æœæ˜¯è´´æ–‡-å¹³å°å…³ç³»ï¼Œä½¿ç”¨å¹³å°é¢œè‰²
                            if (type === 'post-platform') {
                                const platformId = target; // ç›®æ ‡èŠ‚ç‚¹æ˜¯å¹³å°
                                const platformName = extractPlatformFromPlatformId(platformId);
                                linkColor = getPlatformColorForEvolution(platformName);
                            }
                            
                            links.push({
                                source: source,
                                target: target,
                                type: type,
                                weight: weight,
                                color: linkColor,
                                width: getLinkWidth(type, weight)
                            });
                        }
                    }
                }
            });
            
            allNodes = Array.from(nodes.values());
            allLinks = links;
            
            console.log('å¤„ç†å®Œæˆ:', {
                totalNodes: allNodes.length,
                totalLinks: allLinks.length,
                pathPostIdsIncluded: allNodes.filter(n => n.type === 'post' && pathPostIds.has(n.id)).length,
                nodeTypes: {
                    user: allNodes.filter(n => n.type === 'user').length,
                    post: allNodes.filter(n => n.type === 'post').length,
                    platform: allNodes.filter(n => n.type === 'platform').length
                },
                linkTypes: {
                    'user-post': allLinks.filter(l => l.type === 'user-post').length,
                    'post-platform': allLinks.filter(l => l.type === 'post-platform').length,
                    'post-spread': allLinks.filter(l => l.type === 'post-spread').length
                }
            });
            
            // æ˜¾ç¤ºä¸€äº›èŠ‚ç‚¹ç¤ºä¾‹
            if (allNodes.length > 0) {
                console.log('èŠ‚ç‚¹ç¤ºä¾‹:');
                allNodes.slice(0, 5).forEach(node => {
                    console.log(`  ${node.id} -> ${node.type} (${node.color})`);
                });
            }
        }
        
        // åˆ›å»ºèŠ‚ç‚¹
        function createNode(id) {
            const nodeType = getNodeType(id);
            const node = {
                id: id,
                name: id,
                shortName: getShortName(id),
                type: nodeType,
                color: getNodeColor(id),
                size: getNodeSize(id)
            };
            
            // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå‰å‡ ä¸ªèŠ‚ç‚¹çš„ç±»å‹
            if (Math.random() < 0.01) { // åªæ˜¾ç¤º1%çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
                console.log(`èŠ‚ç‚¹ç±»å‹åˆ¤æ–­: ${id} -> ${nodeType} (é¢œè‰²: ${node.color})`);
            }
            
            return node;
        }
        
        // åˆå§‹åŒ–å¯è§†åŒ–
        function initializeVisualization() {
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // ç§»é™¤åŠ è½½æç¤º
            container.querySelector('.loading').remove();
            
            // åˆ›å»ºSVG
            svg = d3.select('#network-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // åˆ›å»ºä¸»ç»„
            const g = svg.append('g');
            
            // åˆ›å»ºå·¥å…·æç¤º
            tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // åº”ç”¨è¿‡æ»¤å¹¶æ›´æ–°æ˜¾ç¤º
            applyFilters();
        }
        
        // åº”ç”¨è¿‡æ»¤
        function applyFilters() {
            // è¿‡æ»¤èŠ‚ç‚¹
            filteredNodes = allNodes.filter(node => {
                if (!showUsers && node.type === 'user') return false;
                if (!showPosts && node.type === 'post') return false;
                if (!showPlatforms && node.type === 'platform') return false;
                return true;
            });
            
            // è¿‡æ»¤è¾¹
            filteredLinks = allLinks.filter(link => {
                if (link.type === 'post-spread' && link.weight < weightThreshold) return false;
                return true;
            });
            
            // æ ¹æ®å½“å‰è§†å›¾è¿›ä¸€æ­¥è¿‡æ»¤è¾¹
            if (currentView === 'user-post') {
                filteredLinks = filteredLinks.filter(link => link.type === 'user-post');
            } else if (currentView === 'post-platform') {
                filteredLinks = filteredLinks.filter(link => link.type === 'post-platform');
            } else if (currentView === 'post-spread') {
                filteredLinks = filteredLinks.filter(link => link.type === 'post-spread');
            }
            
            // åªä¿ç•™æœ‰è¿æ¥çš„èŠ‚ç‚¹ï¼ˆä½†ä¿ç•™å­¤ç«‹èŠ‚ç‚¹å¦‚æœå®ƒä»¬è¢«é€‰ä¸­ï¼‰
            const connectedNodes = new Set();
            filteredLinks.forEach(link => {
                connectedNodes.add(link.source);
                connectedNodes.add(link.target);
            });
            
            // ä¿ç•™æœ‰è¿æ¥çš„èŠ‚ç‚¹ï¼Œä»¥åŠå½“å‰é€‰ä¸­çš„å­¤ç«‹èŠ‚ç‚¹
            filteredNodes = filteredNodes.filter(node => {
                return connectedNodes.has(node.id) || 
                       (node.type === 'user' && showUsers) ||
                       (node.type === 'post' && showPosts) ||
                       (node.type === 'platform' && showPlatforms);
            });
            
            console.log('è¿‡æ»¤å:', {
                nodes: filteredNodes.length,
                links: filteredLinks.length,
                connectedNodes: connectedNodes.size
            });
            
            updateVisualization();
        }
        
        // æ›´æ–°å¯è§†åŒ–
        function updateVisualization() {
            if (!svg) return;
            
            console.log('æ›´æ–°å¯è§†åŒ–:', {
                nodes: filteredNodes.length,
                links: filteredLinks.length,
                view: currentView
                // aggregationMode: aggregationMode
            });
            
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // æ¸…é™¤ç°æœ‰å†…å®¹
            svg.selectAll('*').remove();
            
            // é‡æ–°æ·»åŠ ç¼©æ”¾
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            const g = svg.append('g');
            
            // åˆ›å»ºåŠ›å¯¼å‘å¸ƒå±€
            simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(50))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(20));
            
            // ç»˜åˆ¶è¾¹
            const link = g.append('g')
                .selectAll('line')
                .data(filteredLinks)
                .enter().append('line')
                .attr('stroke', d => d.color)
                .attr('stroke-width', d => d.width)
                .attr('opacity', d => {
                    // æ ¹æ®è¾¹ç±»å‹è®¾ç½®ä¸åŒçš„é€æ˜åº¦
                    if (d.type === 'post-spread') {
                        return 0.2; // ä¼ æ’­å…³ç³»æ›´é€æ˜
                    } else if (d.type === 'user-post') {
                        return 0.7; // ç”¨æˆ·-å¸–æ–‡å…³ç³»ç¨é€æ˜
                    } else if (d.type === 'post-platform') {
                        return 0.8; // å¸–æ–‡-å¹³å°å…³ç³»è¾ƒæ¸…æ™°
                    }
                    return 0.6; // é»˜è®¤é€æ˜åº¦
                });
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('circle')
                .data(filteredNodes)
                .enter().append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => d.color)
                .attr('stroke', d => {
                    // ä¸ºå¹³å°èŠ‚ç‚¹æ·»åŠ ç‰¹æ®Šè¾¹æ¡†
                    if (d.type === 'platform') {
                        if (d.id === 'P_5' || d.id === 'å¾®åš') {
                            return '#4A90E2'; // å¾®åšè“è‰²è¾¹æ¡†
                        } else if (d.id === 'P_1' || d.id === 'ç½‘æ˜“æ–°é—»') {
                            return '#C3AB32'; // ç½‘æ˜“æ–°é—»é»„è‰²è¾¹æ¡†
                        } else if (d.id === 'P_0' || d.id === 'æŠ–éŸ³') {
                            return '#AC6158'; // æŠ–éŸ³çº¢è‰²è¾¹æ¡†
                        } else if (d.id === 'P_2' || d.id === 'ä»Šæ—¥å¤´æ¡') {
                            return '#AD748C'; // ä»Šæ—¥å¤´æ¡ç´«è‰²è¾¹æ¡†
                        } else if (d.id === 'P_4' || d.id === 'å°çº¢ä¹¦') {
                            return '#3E5555'; // å°çº¢ä¹¦æ·±ç»¿è‰²è¾¹æ¡†
                        } else if (d.id === 'P_3' || d.id === 'å¾®ä¿¡') {
                            return '#E17D66'; // å¾®ä¿¡æ©™è‰²è¾¹æ¡†
                        }
                        return '#333'; // å…¶ä»–å¹³å°é»‘è‰²è¾¹æ¡†
                    }
                    return '#fff';
                })
                .attr('stroke-width', d => {
                    // ä¸ºå¹³å°èŠ‚ç‚¹æ·»åŠ æ›´ç²—çš„è¾¹æ¡†
                    if (d.type === 'platform') {
                        return 3;
                    }
                    return 2;
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            console.log('ç»˜åˆ¶çš„èŠ‚ç‚¹æ•°:', node.size());
            console.log('ç»˜åˆ¶çš„è¾¹æ•°:', link.size());
            
            // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾
            const label = g.append('g')
                .selectAll('text')
                .data(filteredNodes)
                .enter().append('text')
                .text(d => {
                    if (!showLabels) return '';
                    if (d.count && d.count > 1) {
                        return `${d.shortName} (${d.count})`;
                    }
                    return d.shortName;
                })
                .attr('font-size', '10px')
                .attr('fill', '#333')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em');
            
            // æ·»åŠ è¾¹æƒé‡æ ‡ç­¾
            const weightLabel = g.append('g')
                .selectAll('text')
                .data(showWeights ? filteredLinks.filter(d => d.type === 'post-spread' || d.type.includes('link')) : [])
                .enter().append('text')
                .text(d => {
                    if (d.count && d.count > 1) {
                        return `${d.weight.toFixed(3)} (${d.count})`;
                    }
                    return d.weight.toFixed(3);
                })
                .attr('font-size', '8px')
                .attr('fill', '#666')
                .attr('text-anchor', 'middle');
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            node.on('mouseover', function(event, d) {
                d3.select(this).attr('r', d.size * 1.5);
                showTooltip(event, d);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).attr('r', d.size);
                hideTooltip();
            })
            .on('click', function(event, d) {
                // ç‚¹å‡»èŠ‚ç‚¹æ—¶é«˜äº®æ˜¾ç¤º
                highlightNode(d);
            });
            
            // æ›´æ–°ä½ç½®
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
                
                weightLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);
            });
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿
            updateNetworkInfo();
            updatePerformanceInfo();
            
            // æ›´æ–°åŠ¨æ€å›¾ä¾‹
            updateDynamicLegend();
        }
        
        // è·å–èŠ‚ç‚¹ç±»å‹
        function getNodeType(id) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¹³å°èŠ‚ç‚¹ï¼ˆP_æ ¼å¼æˆ–çº¯å¹³å°åç§°ï¼‰
            if (id.startsWith('P_') || ['WB', 'WYXW', 'DY', 'JRTT', 'XHS', 'VX', 'å¾®åš', 'ç½‘æ˜“æ–°é—»', 'æŠ–éŸ³', 'ä»Šæ—¥å¤´æ¡', 'å°çº¢ä¹¦', 'å¾®ä¿¡'].includes(id)) {
                return 'platform';
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¸–æ–‡èŠ‚ç‚¹ï¼ˆæ—¶é—´æˆ³æ ¼å¼ï¼‰
            if (id.match(/^(VX|JRTT|WB|DY|XHS|WYXW)_\d{8,}_\d+$/)) {
                return 'post';
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·èŠ‚ç‚¹ï¼ˆç”¨æˆ·åæ ¼å¼ï¼‰
            if (id.match(/^(VX|JRTT|WB|DY|XHS|WYXW)_.*_\d+$/)) {
                return 'user';
            }
            
            // é»˜è®¤è¿”å›ç”¨æˆ·ç±»å‹
            return 'user';
        }
        
        // è·å–èŠ‚ç‚¹é¢œè‰²
        function getNodeColor(id) {
            const type = getNodeType(id);
            
            // å¦‚æœæ˜¯å¹³å°èŠ‚ç‚¹ï¼ŒæŒ‰å¹³å°é¢œè‰²ç¼–ç 
            if (type === 'platform') {
                const platform = extractPlatformFromPlatformId(id);
                return getPlatformColorForEvolution(platform);
            }
            
            // å¦‚æœæ˜¯è´´æ–‡èŠ‚ç‚¹ï¼Œæ ¹æ®å¹³å°IDä½¿ç”¨å¹³å°é¢œè‰²
            if (type === 'post') {
                // ä»è´´æ–‡IDä¸­æå–å¹³å°ä¿¡æ¯
                const platformId = extractPlatformFromPostId(id);
                console.log('è´´æ–‡èŠ‚ç‚¹é¢œè‰²è®¾ç½®:', id, '-> platformId:', platformId);
                if (platformId) {
                    const color = getPlatformColor(platformId);
                    console.log('è´´æ–‡èŠ‚ç‚¹æœ€ç»ˆé¢œè‰²:', id, '->', color);
                    return color;
                }
                return '#4ecdc4'; // é»˜è®¤é¢œè‰²
            }
            
            // å…¶ä»–èŠ‚ç‚¹ç±»å‹ä¿æŒåŸè‰²
            switch (type) {
                case 'user': return '#ff6b6b';
                default: return '#95a5a6';
            }
        }
        
        // ä»è´´æ–‡IDæå–å¹³å°ID
        function extractPlatformFromPostId(postId) {
            // è´´æ–‡IDæ ¼å¼é€šå¸¸æ˜¯: å¹³å°ä»£ç _æ—¶é—´æˆ³_åºå·
            // ä¾‹å¦‚: DY_202412071736_8, WYXW_202412121506_12
            const parts = postId.split('_');
            if (parts.length >= 1) {
                const platformCode = parts[0];
                // å°†å¹³å°ä»£ç æ˜ å°„åˆ°å¹³å°ID
                const platformMapping = {
                    'DY': 'P_0',    // æŠ–éŸ³
                    'WYXW': 'P_1',  // ç½‘æ˜“æ–°é—»
                    'JRTT': 'P_2',  // ä»Šæ—¥å¤´æ¡
                    'VX': 'P_3',    // å¾®ä¿¡
                    'XHS': 'P_4',   // å°çº¢ä¹¦
                    'WB': 'P_5'     // å¾®åš
                };
                console.log('platformMapping[platformCode]',platformMapping[platformCode]);
                return platformMapping[platformCode] || null;
            }
            return null;
        }
        
        // ä»å¹³å°IDæå–å¹³å°ä¿¡æ¯
        function extractPlatformFromPlatformId(id) {
            // å¹³å°IDæ˜ å°„å…³ç³»ï¼ˆæ”¯æŒP_æ ¼å¼å’Œç®€çŸ­ä»£å·ï¼‰
            const platformMapping = {
                'P_0': 'æŠ–éŸ³',  
                'P_1': 'ç½‘æ˜“æ–°é—»', 
                'P_2': 'ä»Šæ—¥å¤´æ¡',  
                'P_3': 'å¾®ä¿¡',  
                'P_4': 'å°çº¢ä¹¦', 
                'P_5': 'å¾®åš',   
                'WB': 'å¾®åš',   
                'WYXW': 'ç½‘æ˜“æ–°é—»',
                'DY': 'æŠ–éŸ³',   
                'JRTT': 'ä»Šæ—¥å¤´æ¡',
                'XHS': 'å°çº¢ä¹¦', 
                'VX': 'å¾®ä¿¡'   
            };
            
            return platformMapping[id] || 'æœªçŸ¥å¹³å°';
        }
        

        
        // è·å–èŠ‚ç‚¹å¤§å°
        function getNodeSize(id) {
            const type = getNodeType(id);
            switch (type) {
                case 'user': return 5; 
                case 'post': return 4;
                case 'platform': return 10;
                default: return 4;
            }
        }
        
        // è·å–çŸ­åç§°
        function getShortName(id) {
            // å¦‚æœæ˜¯å¹³å°èŠ‚ç‚¹ï¼Œè¿”å›å®Œæ•´çš„å¹³å°åç§°
            if (getNodeType(id) === 'platform') {
                return extractPlatformFromPlatformId(id);
            }
            
            // å…¶ä»–èŠ‚ç‚¹æŒ‰åŸé€»è¾‘å¤„ç†
            if (id.length > 12) {
                return id.substring(0, 9) + '...';
            }
            return id;
        }
        
        // è·å–è¾¹é¢œè‰²
        function getLinkColor(type) {
            switch (type) {
                case 'user-post': return '#ff6b6b';
                case 'post-platform': return '#45b7d1'; // è´´æ–‡-å¹³å°å…³ç³»ä½¿ç”¨å¹³å°é¢œè‰²
                case 'post-spread': return '#96ceb4';
                default: return '#999';
            }
        }
        
        // è·å–è¾¹å®½åº¦
        function getLinkWidth(type, weight) {
            if (type === 'post-spread') {
                return Math.max(1, weight * 20);
            }
            return 2;
        }
        
        // æ‹–æ‹½åŠŸèƒ½
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // å·¥å…·æç¤º
        function showTooltip(event, d) {
            tooltip.transition()
                .duration(200)
                .style('opacity', .9);
            
            let displayName = d.name;
            // å¦‚æœæ˜¯å¹³å°èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºå®Œæ•´çš„å¹³å°åç§°
            if (d.type === 'platform') {
                displayName = extractPlatformFromPlatformId(d.name);
            }
            
            let tooltipContent = `
                <strong>${getNodeTypeName(d.type)}</strong><br>
                ID: ${displayName}<br>
                ç±»å‹: ${d.type}
            `;
            
            if (d.count && d.count > 1) {
                tooltipContent += `<br>åŒ…å«èŠ‚ç‚¹æ•°: ${d.count}`;
            }
            
            if (d.members && d.members.length > 0) {
                tooltipContent += `<br>æˆå‘˜: ${d.members.slice(0, 3).join(', ')}`;
                if (d.members.length > 3) {
                    tooltipContent += `... (å…±${d.members.length}ä¸ª)`;
                }
            }
            
            tooltip.html(tooltipContent)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }
        
        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style('opacity', 0);
        }
        
        // é«˜äº®èŠ‚ç‚¹
        function highlightNode(selectedNode) {
            // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„æ ·å¼
            svg.selectAll('circle').attr('opacity', 0.3);
            
            // é«˜äº®é€‰ä¸­çš„èŠ‚ç‚¹
            svg.selectAll('circle').filter(d => d.id === selectedNode.id)
                .attr('opacity', 1)
                .attr('r', d => d.size * 2); // æ”¾å¤§é€‰ä¸­çš„èŠ‚ç‚¹
            
            // é«˜äº®ä¸é€‰ä¸­èŠ‚ç‚¹ç›¸è¿çš„è¾¹
            svg.selectAll('line').attr('opacity', 0.1);
            svg.selectAll('line').filter(d => 
                d.source.id === selectedNode.id || d.target.id === selectedNode.id
            ).attr('opacity', 0.9);
            
            // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
            console.log('é«˜äº®èŠ‚ç‚¹:', selectedNode);
            
            // 3ç§’åæ¢å¤æ‰€æœ‰èŠ‚ç‚¹
            setTimeout(() => {
                svg.selectAll('circle').attr('opacity', 1).attr('r', d => d.size);
                svg.selectAll('line').attr('opacity', 0.6);
            }, 3000);
        }
        
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateNetworkInfo() {
            const userNodes = filteredNodes.filter(n => n.type === 'user').length;
            const postNodes = filteredNodes.filter(n => n.type === 'post').length;
            const platformNodes = filteredNodes.filter(n => n.type === 'platform').length;
            const communityNodes = filteredNodes.filter(n => n.type === 'community').length;
            
            // æ›´æ–°æ§åˆ¶é¢æ¿ä¸­çš„ç½‘ç»œä¿¡æ¯
            document.getElementById('node-count').textContent = filteredNodes.length;
            document.getElementById('edge-count').textContent = filteredLinks.length;
            document.getElementById('current-view').textContent = getViewName(currentView);
            document.getElementById('user-count').textContent = userNodes;
            document.getElementById('post-count').textContent = postNodes;
            document.getElementById('platform-count').textContent = platformNodes;
            document.getElementById('threshold-display').textContent = weightThreshold.toFixed(3);
        }
        
        // è·å–èšåˆæ¨¡å¼åç§°
        function getAggregationModeName(mode) {
            const names = {
                'none': 'æ— èšåˆ',
                'community': 'ç¤¾åŒºèšåˆ',
                'platform': 'å¹³å°èšåˆ',
                'user': 'ç”¨æˆ·èšåˆ',
                'simple': 'ç®€åŒ–èšåˆ'
            };
            return names[mode] || mode;
        }
        
        // æ›´æ–°æ€§èƒ½ä¿¡æ¯
        function updatePerformanceInfo() {
            const performanceInfo = document.getElementById('performance-info');
            const fps = Math.round(1000 / (Date.now() - (window.lastTime || Date.now())));
            window.lastTime = Date.now();
            
            performanceInfo.innerHTML = `
                èŠ‚ç‚¹: ${filteredNodes.length} | 
                è¾¹: ${filteredLinks.length}
            `;
        }
        
        // è·å–èŠ‚ç‚¹ç±»å‹ä¸­æ–‡åç§°
        function getNodeTypeName(type) {
            const names = {
                'user': 'ç”¨æˆ·',
                'post': 'å¸–æ–‡',
                'platform': 'å¹³å°',
                'community': 'ç¤¾åŒº'
            };
            return names[type] || type;
        }
        
        // è·å–è§†å›¾åç§°
        function getViewName(view) {
            const names = {
                'all': 'å…¨éƒ¨å…³ç³»',
                'user-post': 'ç”¨æˆ·-å¸–æ–‡',
                'post-platform': 'å¸–æ–‡-å¹³å°',
                'post-spread': 'å¸–æ–‡ä¼ æ’­'
            };
            return names[view] || view;
        }
        
        // åˆ‡æ¢è§†å›¾
        function showView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°åº”ç”¨è¿‡æ»¤ï¼ˆåŒ…æ‹¬è§†å›¾è¿‡æ»¤ï¼‰
            applyFilters();
        }
        
        // æ›´æ–°æƒé‡è¿‡æ»¤
        function updateWeightFilter() {
            weightThreshold = parseFloat(document.getElementById('weight-slider').value);
            document.getElementById('weight-value').textContent = weightThreshold.toFixed(2);
            applyFilters();
        }
        
        // æ›´æ–°èŠ‚ç‚¹è¿‡æ»¤
        function updateNodeFilter() {
            showUsers = document.getElementById('show-users').checked;
            showPosts = document.getElementById('show-posts').checked;
            showPlatforms = document.getElementById('show-platforms').checked;
            applyFilters();
        }
        
        // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
        function updateLabels() {
            showLabels = document.getElementById('show-labels').checked;
            updateVisualization();
        }
        
        // æ›´æ–°æƒé‡æ˜¾ç¤º
        function updateWeights() {
            showWeights = document.getElementById('show-weights').checked;
            updateVisualization();
        }

        // æ›´æ–°èšåˆè®¡æ•°æ˜¾ç¤º
        // function updateCounts() {
        //     const showCounts = document.getElementById('show-counts').checked;
        //     if (showCounts && aggregationMode !== 'none') {
        //         // æ ¹æ®èšåˆæ¨¡å¼å¤„ç†æ•°æ®
        //         const { aggregatedNodes: nodes, aggregatedLinks: links } = aggregateData();
        //         filteredNodes = nodes;
        //         filteredLinks = links;
        //     } else {
        //         // å–æ¶ˆèšåˆï¼Œæ¢å¤åŸå§‹æ•°æ®
        //         applyFilters();
        //         return;
        //     }
        //     updateVisualization();
        // }
        
        // èšåˆæ•°æ®
        // function aggregateData() {
        //     const aggregatedNodes = new Map();
        //     const aggregatedLinks = [];
        //     
        //     if (aggregationMode === 'community') {
        //         return aggregateByCommunity();
        //     } else if (aggregationMode === 'platform') {
        //         return aggregateByPlatform();
        //     } else if (aggregationMode === 'user') {
        //         return aggregateByUser();
        //     } else if (aggregationMode === 'simple') {
        //         return aggregateBySimple();
        //     }
        //     
        //     return { aggregatedNodes: [], aggregatedLinks: [] };
        // }
        
        // æŒ‰ç¤¾åŒºèšåˆ
        function aggregateByCommunity() {
            const communities = new Map();
            const communityLinks = new Map();
            
            // æ£€æµ‹ç¤¾åŒºï¼ˆåŸºäºè¿æ¥åº¦ï¼‰
            const nodeCommunities = detectCommunities(filteredNodes, filteredLinks);
            
            // èšåˆèŠ‚ç‚¹
            filteredNodes.forEach(node => {
                const communityId = nodeCommunities.get(node.id) || 'community_' + node.id.split('_')[0];
                if (!communities.has(communityId)) {
                    communities.set(communityId, {
                        id: communityId,
                        name: `ç¤¾åŒº ${communityId}`,
                        shortName: `ç¤¾åŒº${communityId}`,
                        type: 'community',
                        color: getCommunityColor(communityId),
                        size: 12,
                        count: 0,
                        members: []
                    });
                }
                const community = communities.get(communityId);
                community.count++;
                community.members.push(node.id);
            });
            
            // èšåˆè¾¹
            filteredLinks.forEach(link => {
                const sourceCommunity = nodeCommunities.get(link.source) || 'community_' + link.source.split('_')[0];
                const targetCommunity = nodeCommunities.get(link.target) || 'community_' + link.target.split('_')[0];
                
                if (sourceCommunity !== targetCommunity) {
                    const linkKey = `${sourceCommunity}-${targetCommunity}`;
                    if (!communityLinks.has(linkKey)) {
                        communityLinks.set(linkKey, {
                            source: communities.get(sourceCommunity),
                            target: communities.get(targetCommunity),
                            type: 'community-link',
                            weight: 0,
                            count: 0,
                            color: '#808080',
                            width: 2
                        });
                    }
                    const communityLink = communityLinks.get(linkKey);
                    communityLink.weight += link.weight;
                    communityLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(communities.values()),
                aggregatedLinks: Array.from(communityLinks.values())
            };
        }
        
        // æŒ‰å¹³å°èšåˆ
        function aggregateByPlatform() {
            const platforms = new Map();
            const platformLinks = new Map();
            
            // èšåˆèŠ‚ç‚¹
            filteredNodes.forEach(node => {
                const platformId = extractPlatform(node.id);
                if (!platforms.has(platformId)) {
                    platforms.set(platformId, {
                        id: platformId,
                        name: platformId,
                        shortName: platformId,
                        type: 'platform',
                        color: getPlatformColorForEvolution(platformId),
                        size: 10,
                        count: 0,
                        members: []
                    });
                }
                const platform = platforms.get(platformId);
                platform.count++;
                platform.members.push(node.id);
            });
            
            // èšåˆè¾¹
            filteredLinks.forEach(link => {
                const sourcePlatform = extractPlatform(link.source);
                const targetPlatform = extractPlatform(link.target);
                
                if (sourcePlatform !== targetPlatform) {
                    const linkKey = `${sourcePlatform}-${targetPlatform}`;
                    if (!platformLinks.has(linkKey)) {
                        platformLinks.set(linkKey, {
                            source: platforms.get(sourcePlatform),
                            target: platforms.get(targetPlatform),
                            type: 'platform-link',
                            weight: 0,
                            count: 0,
                            color: '#45b7d1',
                            width: 2
                        });
                    }
                    const platformLink = platformLinks.get(linkKey);
                    platformLink.weight += link.weight;
                    platformLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(platforms.values()),
                aggregatedLinks: Array.from(platformLinks.values())
            };
        }
        
        // æŒ‰ç”¨æˆ·èšåˆ
        function aggregateByUser() {
            const users = new Map();
            const userLinks = new Map();
            
            // èšåˆèŠ‚ç‚¹
            filteredNodes.forEach(node => {
                const userId = extractUser(node.id);
                if (!users.has(userId)) {
                    users.set(userId, {
                        id: userId,
                        name: userId,
                        shortName: userId,
                        type: 'user',
                        color: '#ff6b6b',
                        size: 8,
                        count: 0,
                        members: []
                    });
                }
                const user = users.get(userId);
                user.count++;
                user.members.push(node.id);
            });
            
            // èšåˆè¾¹
            filteredLinks.forEach(link => {
                const sourceUser = extractUser(link.source);
                const targetUser = extractUser(link.target);
                
                if (sourceUser !== targetUser) {
                    const linkKey = `${sourceUser}-${targetUser}`;
                    if (!userLinks.has(linkKey)) {
                        userLinks.set(linkKey, {
                            source: users.get(sourceUser),
                            target: users.get(targetUser),
                            type: 'user-link',
                            weight: 0,
                            count: 0,
                            color: '#ff6b6b',
                            width: 2
                        });
                    }
                    const userLink = userLinks.get(linkKey);
                    userLink.weight += link.weight;
                    userLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(users.values()),
                aggregatedLinks: Array.from(userLinks.values())
            };
        }

        // ç®€åŒ–èšåˆ (ä»…ç”¨äºå¤§é‡æ•°æ®)
        function aggregateBySimple() {
            const aggregatedNodes = new Map();
            const aggregatedLinks = [];

            // èšåˆèŠ‚ç‚¹
            filteredNodes.forEach(node => {
                const id = node.id;
                if (!aggregatedNodes.has(id)) {
                    aggregatedNodes.set(id, {
                        id: id,
                        name: id,
                        shortName: getShortName(id),
                        type: getNodeType(id),
                        color: getNodeColor(id),
                        size: getNodeSize(id),
                        count: 0,
                        members: []
                    });
                }
                const aggNode = aggregatedNodes.get(id);
                aggNode.count++;
                aggNode.members.push(id);
            });

            // èšåˆè¾¹
            filteredLinks.forEach(link => {
                const source = link.source;
                const target = link.target;
                const weight = link.weight;

                if (!aggregatedNodes.has(source) || !aggregatedNodes.has(target)) {
                    // å¦‚æœæºæˆ–ç›®æ ‡èŠ‚ç‚¹æœªèšåˆï¼Œåˆ™è·³è¿‡è¯¥è¾¹
                    return;
                }

                const sourceAgg = aggregatedNodes.get(source);
                const targetAgg = aggregatedNodes.get(target);

                if (sourceAgg.type === targetAgg.type) { // åŒç±»èŠ‚ç‚¹èšåˆ
                    const linkKey = `${sourceAgg.id}-${targetAgg.id}`;
                    if (!aggregatedLinks.some(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id)) {
                        aggregatedLinks.push({
                            source: sourceAgg,
                            target: targetAgg,
                            type: 'simple-link', // ç®€åŒ–èšåˆè¾¹
                            weight: 0,
                            count: 0,
                            color: getLinkColor(link.type), // ä½¿ç”¨åŸå§‹è¾¹é¢œè‰²
                            width: getLinkWidth(link.type, weight)
                        });
                    }
                    const simpleLink = aggregatedLinks.find(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id);
                    simpleLink.weight += weight;
                    simpleLink.count++;
                } else { // ä¸åŒç±»èŠ‚ç‚¹èšåˆ
                    const linkKey = `${sourceAgg.id}-${targetAgg.id}`;
                    if (!aggregatedLinks.some(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id)) {
                        aggregatedLinks.push({
                            source: sourceAgg,
                            target: targetAgg,
                            type: 'simple-link', // ç®€åŒ–èšåˆè¾¹
                            weight: 0,
                            count: 0,
                            color: '#808080', // èšåˆè¾¹é¢œè‰²
                            width: 2
                        });
                    }
                    const simpleLink = aggregatedLinks.find(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id);
                    simpleLink.weight += weight;
                    simpleLink.count++;
                }
            });

            return {
                aggregatedNodes: Array.from(aggregatedNodes.values()),
                aggregatedLinks: aggregatedLinks
            };
        }
        
        // ç¤¾åŒºæ£€æµ‹ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function detectCommunities(nodes, links) {
            const nodeCommunities = new Map();
            const visited = new Set();
            let communityId = 0;
            
            // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…ç¤¾åŒº
            nodes.forEach(node => {
                if (!visited.has(node.id)) {
                    const community = new Set();
                    dfs(node.id, links, visited, community);
                    
                    // ä¸ºç¤¾åŒºåˆ†é…ID
                    community.forEach(nodeId => {
                        nodeCommunities.set(nodeId, communityId);
                    });
                    communityId++;
                }
            });
            
            return nodeCommunities;
        }
        
        // æ·±åº¦ä¼˜å…ˆæœç´¢
        function dfs(nodeId, links, visited, community) {
            visited.add(nodeId);
            community.add(nodeId);
            
            // æŸ¥æ‰¾è¿æ¥çš„èŠ‚ç‚¹
            links.forEach(link => {
                if (link.source === nodeId && !visited.has(link.target)) {
                    dfs(link.target, links, visited, community);
                }
                if (link.target === nodeId && !visited.has(link.source)) {
                    dfs(link.source, links, visited, community);
                }
            });
        }
        
        // æå–å¹³å°ä¿¡æ¯
        function extractPlatform(nodeId) {
            const parts = nodeId.split('_');
            if (parts.length > 0) {
                return parts[0];
            }
            return 'unknown';
        }
        
        // æå–ç”¨æˆ·ä¿¡æ¯
        function extractUser(nodeId) {
            const parts = nodeId.split('_');
            if (parts.length > 1) {
                return parts[1];
            }
            return nodeId;
        }
        
        // è·å–ç¤¾åŒºé¢œè‰²
        function getCommunityColor(communityId) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
            const index = parseInt(communityId.toString().replace(/\D/g, '')) % colors.length;
            return colors[index];
        }
        
        // è·å–å¹³å°é¢œè‰²
        function getPlatformColor(platformId) {
            const platformColors = {
                'P_5': '#4A90E2', // å¾®åšè“è‰²
                'P_1': '#C3AB32', // ç½‘æ˜“æ–°é—»é»„è‰²
                'P_0': '#AC6158', // æŠ–éŸ³çº¢è‰²
                'P_2': '#AD748C', // ä»Šæ—¥å¤´æ¡ç´«è‰²
                'P_4': '#3E5555', // å°çº¢ä¹¦æ·±ç»¿è‰²
                'P_3': '#E17D66', // å¾®ä¿¡æ©™è‰²
                'å¾®åš': '#4A90E2',
                'å¾®ä¿¡': '#E17D66',
                'æŠ–éŸ³': '#AC6158',
                'ä»Šæ—¥å¤´æ¡': '#AD748C',
                'å°çº¢ä¹¦': '#3E5555',
                'ç½‘æ˜“æ–°é—»': '#C3AB32'
            };
            console.log('getPlatformColor è¾“å…¥:', platformId);
            console.log('platformColors[platformId]:', platformColors[platformId]);
            const result = platformColors[platformId] || '#808080';
            console.log('getPlatformColor è¾“å‡º:', result);
            return result;
        }
        
        // åˆ‡æ¢è·¯å¾„è¿‡æ»¤
        function togglePathFilter() {
            const enableFilter = document.getElementById('enable-path-filter').checked;
            console.log('è·¯å¾„è¿‡æ»¤çŠ¶æ€:', enableFilter);
            
            // é‡æ–°å¤„ç†æ•°æ®
            if (networkData) {
                if (enableFilter && window.pathPostIds) {
                    processAllData(window.pathPostIds);
                } else {
                    processAllData(new Set()); // ç©ºé›†åˆè¡¨ç¤ºä¸è¿‡æ»¤
                }
                applyFilters();
            }
        }
        
        // è®¾ç½®èšåˆæ¨¡å¼
        // function setAggregationMode(mode) {
        //     aggregationMode = mode;
        //     document.querySelectorAll('.control-btn').forEach(btn => {
        //         btn.classList.remove('active');
        //     });
        //     document.querySelector(`.control-btn[onclick="setAggregationMode('${mode}')"]`).classList.add('active');
        //     updateCounts(); // åº”ç”¨æ–°çš„èšåˆæ¨¡å¼
        // }
        
        // é‡ç½®å¸ƒå±€
        function resetLayout() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }
        
        // åˆ‡æ¢æ¨¡æ‹Ÿ
        function toggleSimulation() {
            if (simulation) {
                if (isSimulationRunning) {
                    simulation.stop();
                } else {
                    simulation.alpha(1).restart();
                }
                isSimulationRunning = !isSimulationRunning;
            }
        }
        
        // çŸ¥è¯†å›¾è°±æŸ¥è¯¢åŠŸèƒ½
        function searchNode() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;
            
            const results = [];
            
            // æœç´¢èŠ‚ç‚¹
            allNodes.forEach(node => {
                if (node.id.toLowerCase().includes(query.toLowerCase()) ||
                    node.name.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'node',
                        data: node,
                        match: node.id.includes(query) ? 'exact' : 'partial'
                    });
                }
            });
            
            // æœç´¢è¾¹
            allLinks.forEach(link => {
                if (link.source.toLowerCase().includes(query.toLowerCase()) ||
                    link.target.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'link',
                        data: link,
                        match: 'related'
                    });
                }
            });
            
            displayQueryResults(results, `æœç´¢ "${query}" çš„ç»“æœ`);
        }
        
        function findPath() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;
            
            const parts = query.split('->');
            if (parts.length !== 2) {
                displayQueryResults([], 'è¯·è¾“å…¥æ ¼å¼: èŠ‚ç‚¹A->èŠ‚ç‚¹B');
                return;
            }
            
            const source = parts[0].trim();
            const target = parts[1].trim();
            
            // ç®€å•çš„è·¯å¾„æŸ¥æ‰¾ï¼ˆBFSï¼‰
            const path = findShortestPath(source, target);
            
            if (path) {
                displayQueryResults([{
                    type: 'path',
                    data: path,
                    match: 'exact'
                }], `ä» ${source} åˆ° ${target} çš„è·¯å¾„`);
            } else {
                displayQueryResults([], `æœªæ‰¾åˆ°ä» ${source} åˆ° ${target} çš„è·¯å¾„`);
            }
        }
        
        function findInfluencers() {
            // æŸ¥æ‰¾å½±å“åŠ›æœ€å¤§çš„èŠ‚ç‚¹
            const influenceMap = new Map();
            
            // è®¡ç®—å…¥åº¦ï¼ˆè¢«ä¼ æ’­æ¬¡æ•°ï¼‰
            allLinks.forEach(link => {
                if (link.type === 'post-spread') {
                    const target = link.target;
                    influenceMap.set(target, (influenceMap.get(target) || 0) + link.weight);
                }
            });
            
            // æ’åºå¹¶å–å‰10ä¸ª
            const topInfluencers = Array.from(influenceMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([nodeId, influence]) => ({
                    type: 'influencer',
                    data: { id: nodeId, influence: influence },
                    match: 'top'
                }));
            
            displayQueryResults(topInfluencers, 'å½±å“åŠ›æœ€å¤§çš„èŠ‚ç‚¹ï¼ˆæŒ‰ä¼ æ’­å¼ºåº¦æ’åºï¼‰');
        }
        
        function findShortestPath(source, target) {
            // æ„å»ºé‚»æ¥è¡¨
            const graph = new Map();
            allLinks.forEach(link => {
                if (!graph.has(link.source)) graph.set(link.source, []);
                if (!graph.has(link.target)) graph.set(link.target, []);
                graph.get(link.source).push(link.target);
            });
            
            // BFSæŸ¥æ‰¾æœ€çŸ­è·¯å¾„
            const queue = [[source]];
            const visited = new Set([source]);
            
            while (queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                if (current === target) {
                    return path;
                }
                
                const neighbors = graph.get(current) || [];
                for (const neighbor of neighbors) {
                    if (!visited.has(neighbor)) {
                        visited.add(neighbor);
                        queue.push([...path, neighbor]);
                    }
                }
            }
            
            return null;
        }
        
        function displayQueryResults(results, title) {
            const resultsDiv = document.getElementById('query-results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="query-result">${title}: æ— ç»“æœ</div>`;
                return;
            }
            
            let html = `<div class="query-title">${title} (${results.length}ä¸ªç»“æœ)</div>`;
            
            results.forEach(result => {
                switch (result.type) {
                    case 'node':
                        html += `<div class="query-result">
                            <strong>èŠ‚ç‚¹:</strong> ${result.data.id}<br>
                            <small>ç±»å‹: ${result.data.type}</small>
                        </div>`;
                        break;
                    case 'link':
                        html += `<div class="query-result">
                            <strong>è¾¹:</strong> ${result.data.source} â†’ ${result.data.target}<br>
                            <small>ç±»å‹: ${result.data.type}, æƒé‡: ${result.data.weight.toFixed(3)}</small>
                        </div>`;
                        break;
                    case 'path':
                        html += `<div class="query-result">
                            <strong>è·¯å¾„:</strong> ${result.data.join(' â†’ ')}<br>
                            <small>é•¿åº¦: ${result.data.length - 1} è·³</small>
                        </div>`;
                        break;
                    case 'influencer':
                        html += `<div class="query-result">
                            <strong>å½±å“åŠ›èŠ‚ç‚¹:</strong> ${result.data.id}<br>
                            <small>ä¼ æ’­å¼ºåº¦: ${result.data.influence.toFixed(3)}</small>
                        </div>`;
                        break;
                }
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // é«˜äº®æŸ¥è¯¢ç»“æœ
        function highlightQueryResults(results) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            svg.selectAll('circle').attr('stroke', '#fff').attr('stroke-width', 2);
            svg.selectAll('line').attr('stroke-width', d => d.width);
            
            if (!results || results.length === 0) return;
            
            // é«˜äº®ç›¸å…³èŠ‚ç‚¹å’Œè¾¹
            results.forEach(result => {
                if (result.type === 'node') {
                    svg.selectAll('circle').filter(d => d.id === result.data.id)
                        .attr('stroke', '#ff0000').attr('stroke-width', 4);
                } else if (result.type === 'link') {
                    svg.selectAll('line').filter(d => 
                        d.source === result.data.source && d.target === result.data.target)
                        .attr('stroke-width', d => d.width * 2);
                }
            });
        }
        
        // åˆå§‹åŒ–æ¼”åŒ–æ ‘
        function initializeEvolutionTree() {
            treeContainer = document.getElementById('evolution-tree-container');
            treeContainer.querySelector('.loading').remove();
            
            // åˆ›å»ºæ¼”åŒ–æ ‘å®¹å™¨
            const treeDiv = document.createElement('div');
            treeDiv.className = 'evolution-tree';
            treeContainer.appendChild(treeDiv);
            
            // åˆ›å»ºå·¥å…·æç¤º
            treeTooltip = document.createElement('div');
            treeTooltip.className = 'tree-tooltip';
            treeTooltip.style.opacity = '0';
            document.body.appendChild(treeTooltip);
        }
        
        // å¤„ç†æ¼”åŒ–æ•°æ®
        function processEvolutionData(pathsData) {
            const allPosts = [];
            
            // æå–æ‰€æœ‰å¸–å­å¹¶æŒ‰æ—¶é—´æ’åº
            pathsData.forEach(path => {
                if (path.è·¯å¾„ && Array.isArray(path.è·¯å¾„)) {
                    path.è·¯å¾„.forEach(post => {
                        if (post.å¸–æ–‡ID && post.æ—¶é—´) {
                            allPosts.push({
                                id: post.å¸–æ–‡ID,
                                time: new Date(post.æ—¶é—´),
                                platform: post.å¹³å°,
                                topicId: path.è¯é¢˜ç¼–å· || 0
                            });
                        }
                    });
                }
            });
            
            // æŒ‰æ—¶é—´æ’åº
            allPosts.sort((a, b) => a.time - b.time);
            
            // æŒ‰ä¸»é¢˜åˆ†ç»„
            const topics = new Map();
            allPosts.forEach(post => {
                if (!topics.has(post.topicId)) {
                    topics.set(post.topicId, []);
                }
                topics.get(post.topicId).push(post);
            });
            
            // è¯†åˆ«å…³é”®èŠ‚ç‚¹
            const keyNodes = identifyKeyNodes(allPosts);
            
            // è®¡ç®—çƒ­åº¦
            const heatMap = calculateHeatMap(allPosts);
            
            return {
                posts: allPosts,
                topics: topics,
                keyNodes: keyNodes,
                heatMap: heatMap
            };
        }
        
        // è¯†åˆ«å…³é”®èŠ‚ç‚¹
        function identifyKeyNodes(posts) {
            const keyNodes = new Set();
            
            // ç¬¬ä¸€ä¸ªå¸–å­ä½œä¸ºæ ¹èŠ‚ç‚¹
            if (posts.length > 0) {
                keyNodes.add(posts[0].id);
            }
            
            // è¯†åˆ«å¹³å°è½¬æ¢èŠ‚ç‚¹ï¼ˆå½“è¯é¢˜ä»ä¸€ä¸ªå¹³å°ä¼ æ’­åˆ°å¦ä¸€ä¸ªå¹³å°æ—¶ï¼‰
            for (let i = 1; i < posts.length; i++) {
                const currentPost = posts[i];
                const prevPost = posts[i - 1];
                
                // å¦‚æœå¹³å°å‘ç”Ÿå˜åŒ–ï¼Œæ ‡è®°ä¸ºå…³é”®èŠ‚ç‚¹
                if (currentPost.platform !== prevPost.platform) {
                    keyNodes.add(currentPost.id);
                }
            }
            
            // æ¯ä¸ªä¸»é¢˜çš„æœ€åä¸€ä¸ªå¸–å­ä½œä¸ºå¶å­èŠ‚ç‚¹
            const topicLastPosts = new Map();
            posts.forEach(post => {
                if (!topicLastPosts.has(post.topicId) || 
                    post.time > topicLastPosts.get(post.topicId).time) {
                    topicLastPosts.set(post.topicId, post);
                }
            });
            
            topicLastPosts.forEach(post => {
                keyNodes.add(post.id);
            });
            
            return keyNodes;
        }
        
        // è®¡ç®—çƒ­åº¦æ˜ å°„
        function calculateHeatMap(posts) {
            const heatMap = new Map();
            
            // æŒ‰æ—¶é—´çª—å£è®¡ç®—çƒ­åº¦
            const timeWindows = new Map();
            const windowSize = 60 * 60 * 1000; // 1å°æ—¶çª—å£
            
            posts.forEach(post => {
                const windowKey = Math.floor(post.time.getTime() / windowSize);
                if (!timeWindows.has(windowKey)) {
                    timeWindows.set(windowKey, []);
                }
                timeWindows.get(windowKey).push(post);
            });
            
            // è®¡ç®—æ¯ä¸ªå¸–å­çš„çƒ­åº¦ï¼ˆåŸºäºæ—¶é—´çª—å£å†…çš„å¸–å­æ•°é‡ï¼‰
            posts.forEach(post => {
                const windowKey = Math.floor(post.time.getTime() / windowSize);
                const windowPosts = timeWindows.get(windowKey) || [];
                const heat = windowPosts.length;
                heatMap.set(post.id, heat);
            });
            
            return heatMap;
        }
        
        // è·å–å¹³å°é¢œè‰²ï¼ˆç”¨äºæ¼”åŒ–æ ‘ï¼‰
        function getPlatformColorForEvolution(platform) {
            const colors = {
                'DY': '#AC6158',    // æŠ–éŸ³
                'XHS': '#3E5555',   // å°çº¢ä¹¦
                'WYXW': '#C3AB32',  // ç½‘æ˜“æ–°é—»
                'JRTT': '#AD748C',  // ä»Šæ—¥å¤´æ¡
                'VX': '#E17D66',    // å¾®ä¿¡
                'WB': '#4A90E2',    // å¾®åš
                'æŠ–éŸ³': '#AC6158',    // æŠ–éŸ³
                'å°çº¢ä¹¦': '#3E5555',   // å°çº¢ä¹¦
                'ç½‘æ˜“æ–°é—»': '#C3AB32',  // ç½‘æ˜“æ–°é—»
                'ä»Šæ—¥å¤´æ¡': '#AD748C',  // ä»Šæ—¥å¤´æ¡
                'å¾®ä¿¡': '#E17D66',    // å¾®ä¿¡
                'å¾®åš': '#4A90E2'     // å¾®åš
            };
            return colors[platform] || '#95a5a6';
        }
        
        // ç”Ÿæˆè¯é¢˜å›¾ä¾‹
        function generateTopicLegend(evolutionData) {
            const legendContainer = document.getElementById('topic-legend');
            const treeContainer = document.getElementById('evolution-tree-container');
            // ä½¿ç”¨ä¸æ¼”åŒ–æ ‘ç›¸åŒçš„æ’åºæ–¹å¼
            const topics = Array.from(evolutionData.topics.keys()).sort((a, b) => a - b);
            
            legendContainer.innerHTML = '';
            
            // ä½¿ç”¨ä¸æ¼”åŒ–æ ‘å®Œå…¨ç›¸åŒçš„è®¡ç®—æ–¹å¼
            const topicIds = topics;
            // ä½¿ç”¨æ¼”åŒ–æ ‘å®¹å™¨çš„å®½åº¦ï¼Œç¡®ä¿å®Œå…¨å¯¹åº”
            const width = treeContainer.clientWidth;
            const margin = 20;
            const topicScale = (width - 2 * margin) / Math.max(topicIds.length, 1);
            
            topics.forEach((topicId) => {
                const legendItem = document.createElement('div');
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.gap = '3px';
                legendItem.style.position = 'absolute';
                legendItem.style.top = '50%';
                legendItem.style.transform = 'translateY(-50%)';
                // ä½¿ç”¨ä¸æ¼”åŒ–æ ‘å®Œå…¨ç›¸åŒçš„xåæ ‡è®¡ç®—æ–¹å¼
                const x = margin + (topicIds.indexOf(topicId) * topicScale);
                legendItem.style.left = x + 'px';
                
                const topicDot = document.createElement('div');
                topicDot.style.width = '6px';
                topicDot.style.height = '6px';
                topicDot.style.borderRadius = '50%';
                topicDot.style.backgroundColor = '#666';
                topicDot.style.border = '1px solid #999';
                
                const label = document.createElement('span');
                label.textContent = `è¯é¢˜${topicId}`;
                label.style.fontSize = '9px';
                label.style.color = '#666';
                
                legendItem.appendChild(topicDot);
                legendItem.appendChild(label);
                legendContainer.appendChild(legendItem);
            });
        }
        

        
        // ç»˜åˆ¶æ¼”åŒ–æ ‘
        function drawEvolutionTree(evolutionData) {
            const container = document.getElementById('evolution-tree-container');
            const treeDiv = container.querySelector('.evolution-tree');
            treeDiv.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = 20;
            
            const posts = evolutionData.posts;
            const topics = evolutionData.topics;
            const keyNodes = evolutionData.keyNodes;
            const heatMap = evolutionData.heatMap;
            
            if (posts.length === 0) {
                treeDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // è®¡ç®—æ—¶é—´èŒƒå›´
            const timeRange = posts[posts.length - 1].time - posts[0].time;
            const timeScale = (height - 2 * margin) / timeRange;
            
            // è®¡ç®—ä¸»é¢˜ä½ç½®
            const topicIds = Array.from(topics.keys());
            const topicScale = (width - 2 * margin) / Math.max(topicIds.length, 1);
            
            // ç»˜åˆ¶èŠ‚ç‚¹å’Œè¿æ¥
            const topicPositions = new Map();
            const platformChanges = new Set();
            
            // æ·»åŠ æ—¶é—´æ–¹å‘ç®­å¤´
            const timeArrow = document.createElement('div');
            timeArrow.className = 'time-arrow';
            timeArrow.innerHTML = 'â¬†ï¸ æ—¶é—´';
            treeDiv.appendChild(timeArrow);
            
            posts.forEach((post, index) => {
                const x = margin + (topicIds.indexOf(post.topicId) * topicScale);
                // ä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯æ—¶é—´æ¥è®¡ç®—Yä½ç½®ï¼Œç¡®ä¿é—´éš”ä¸€è‡´
                const y = height - margin - (index * (height - 2 * margin) / (posts.length - 1));
                
                // åˆ›å»ºèŠ‚ç‚¹
                const node = document.createElement('div');
                node.className = 'tree-node';
                
                // æ ¹æ®çƒ­åº¦è°ƒæ•´èŠ‚ç‚¹å¤§å°
                const heat = heatMap.get(post.id) || 1;
                const size = 6 + Math.min(heat * 2, 8); // åŸºç¡€å¤§å°6pxï¼Œçƒ­åº¦å¢åŠ æœ€å¤š8px
                node.style.width = size + 'px';
                node.style.height = size + 'px';
                
                node.style.left = (x - size/2) + 'px';
                node.style.top = (y - size/2) + 'px';
                node.style.backgroundColor = getPlatformColorForEvolution(post.platform);
                node.title = `${post.platform}: ${post.id} (çƒ­åº¦: ${heat})`;
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                node.addEventListener('mouseover', (e) => {
                    showTreeTooltip(e, post);
                });
                
                node.addEventListener('mouseout', () => {
                    hideTreeTooltip();
                });
                
                treeDiv.appendChild(node);
                
                // è®°å½•ä¸»é¢˜ä½ç½®
                if (!topicPositions.has(post.topicId)) {
                    topicPositions.set(post.topicId, { x, y });
                }
                
                // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå¸–å­ï¼‰
                if (index > 0) {
                    const prevPost = posts[index - 1];
                    const prevX = margin + (topicIds.indexOf(prevPost.topicId) * topicScale);
                    const prevY = height - margin - ((index - 1) * (height - 2 * margin) / (posts.length - 1));
                    
                    // å¦‚æœä¸»é¢˜ç›¸åŒï¼Œç»˜åˆ¶å‚ç›´çº¿
                    if (post.topicId === prevPost.topicId) {
                        const link = document.createElement('div');
                        link.className = 'tree-link';
                        link.style.left = x + 'px';
                        link.style.top = prevY + 'px';
                        link.style.width = '1px';
                        link.style.height = (y - prevY) + 'px';
                        treeDiv.appendChild(link);
                    } else {
                        // å¦‚æœä¸»é¢˜ä¸åŒï¼Œç»˜åˆ¶æ–œçº¿
                        const link = document.createElement('div');
                        link.className = 'tree-link';
                        link.style.left = prevX + 'px';
                        link.style.top = prevY + 'px';
                        
                        const length = Math.sqrt(Math.pow(x - prevX, 2) + Math.pow(y - prevY, 2));
                        const angle = Math.atan2(y - prevY, x - prevX) * 180 / Math.PI;
                        
                        link.style.width = length + 'px';
                        link.style.transform = `rotate(${angle}deg)`;
                        treeDiv.appendChild(link);
                        
                        // æ ‡è®°å¹³å°è½¬æ¢
                        platformChanges.add(post.id);
                    }
                }
                

            });
        }
        
        // æ˜¾ç¤ºæ¼”åŒ–æ ‘å·¥å…·æç¤º
        function showTreeTooltip(event, post) {
            treeTooltip.style.opacity = '1';
            treeTooltip.style.left = (event.pageX + 10) + 'px';
            treeTooltip.style.top = (event.pageY - 10) + 'px';
            
            const heat = evolutionData.heatMap.get(post.id) || 1;
            
            treeTooltip.innerHTML = `
                <strong>${post.platform}</strong><br>
                å¸–æ–‡ID: ${post.id}<br>
                æ—¶é—´: ${post.time.toLocaleString()}<br>
                ä¸»é¢˜: ${post.topicId}<br>
                çƒ­åº¦: ${heat}
            `;
        }
        
        // éšè—æ¼”åŒ–æ ‘å·¥å…·æç¤º
        function hideTreeTooltip() {
            treeTooltip.style.opacity = '0';
        }
        
        // æ›´æ–°åŠ¨æ€å›¾ä¾‹
        function updateDynamicLegend() {
            // ç»Ÿè®¡å½“å‰æ˜¾ç¤ºçš„èŠ‚ç‚¹ç±»å‹
            const nodeTypeCounts = {
                user: filteredNodes.filter(n => n.type === 'user').length,
                post: filteredNodes.filter(n => n.type === 'post').length,
                platform: filteredNodes.filter(n => n.type === 'platform').length
            };
            
            // ç»Ÿè®¡å½“å‰æ˜¾ç¤ºçš„è¾¹ç±»å‹
            const linkTypeCounts = {
                'user-post': filteredLinks.filter(l => l.type === 'user-post').length,
                'post-platform': filteredLinks.filter(l => l.type === 'post-platform').length,
                'post-spread': filteredLinks.filter(l => l.type === 'post-spread').length
            };
            
            // ç»Ÿè®¡å¹³å°åˆ†å¸ƒ
            const platformCounts = {};
            filteredNodes.filter(n => n.type === 'platform').forEach(node => {
                const platformName = extractPlatformFromPlatformId(node.id);
                platformCounts[platformName] = (platformCounts[platformName] || 0) + 1;
            });
            
            // æ›´æ–°å›¾ä¾‹ä¸­çš„è®¡æ•°ä¿¡æ¯
            updateLegendCounts(nodeTypeCounts, linkTypeCounts, platformCounts);
        }
        
        // æ›´æ–°å›¾ä¾‹è®¡æ•°
        function updateLegendCounts(nodeCounts, linkCounts, platformCounts) {
            // æ›´æ–°èŠ‚ç‚¹ç±»å‹å›¾ä¾‹
            const nodeLegendItems = document.querySelectorAll('.legend-item');
            nodeLegendItems.forEach(item => {
                const text = item.textContent;
                if (text.includes('ç”¨æˆ·èŠ‚ç‚¹')) {
                    const count = nodeCounts.user || 0;
                    item.innerHTML = item.innerHTML.replace(/ç”¨æˆ·èŠ‚ç‚¹.*/, `ç”¨æˆ·èŠ‚ç‚¹ (å°)`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('user');
                } else if (text.includes('å¸–æ–‡èŠ‚ç‚¹')) {
                    const count = nodeCounts.post || 0;
                    item.innerHTML = item.innerHTML.replace(/å¸–æ–‡èŠ‚ç‚¹.*/, `å¸–æ–‡èŠ‚ç‚¹ (å°)`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('post');
                } else if (text.includes('å¹³å°èŠ‚ç‚¹')) {
                    const count = nodeCounts.platform || 0;
                    item.innerHTML = item.innerHTML.replace(/å¹³å°èŠ‚ç‚¹.*/, `å¹³å°èŠ‚ç‚¹ (å¤§)`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('platform');
                }
            });
            
            // æ›´æ–°è¾¹ç±»å‹å›¾ä¾‹
            const linkLegendItems = document.querySelectorAll('.legend-item');
            linkLegendItems.forEach(item => {
                const text = item.textContent;
                if (text.includes('ç”¨æˆ·-å¸–æ–‡å…³ç³»')) {
                    const count = linkCounts['user-post'] || 0;
                    item.innerHTML = item.innerHTML.replace(/ç”¨æˆ·-å¸–æ–‡å…³ç³».*/, `ç”¨æˆ·-å¸–æ–‡å…³ç³»`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('user-post');
                } else if (text.includes('å¸–æ–‡-å¹³å°å…³ç³»')) {
                    const count = linkCounts['post-platform'] || 0;
                    item.innerHTML = item.innerHTML.replace(/å¸–æ–‡-å¹³å°å…³ç³».*/, `å¸–æ–‡-å¹³å°å…³ç³»`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('post-platform');
                } else if (text.includes('ä¼ æ’­å…³ç³»')) {
                    const count = linkCounts['post-spread'] || 0;
                    item.innerHTML = item.innerHTML.replace(/ä¼ æ’­å…³ç³».*/, `ä¼ æ’­å…³ç³»`);
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('post-spread');
                }
            });
        }
        
        // é«˜äº®èŠ‚ç‚¹ç±»å‹
        function highlightNodeType(nodeType) {
            // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹
            svg.selectAll('circle').attr('opacity', 0.3);
            
            // é«˜äº®æŒ‡å®šç±»å‹çš„èŠ‚ç‚¹
            svg.selectAll('circle').filter(d => d.type === nodeType)
                .attr('opacity', 1)
                .attr('r', d => d.size * 1.5);
            
            // 3ç§’åæ¢å¤
            setTimeout(() => {
                svg.selectAll('circle').attr('opacity', 1).attr('r', d => d.size);
            }, 3000);
        }
        
        // é«˜äº®è¾¹ç±»å‹
        function highlightLinkType(linkType) {
            // é‡ç½®æ‰€æœ‰è¾¹
            svg.selectAll('line').attr('opacity', 0.1);
            
            // é«˜äº®æŒ‡å®šç±»å‹çš„è¾¹
            svg.selectAll('line').filter(d => d.type === linkType)
                .attr('opacity', 0.8)
                .attr('stroke-width', d => d.width * 2);
            
            // 3ç§’åæ¢å¤
            setTimeout(() => {
                svg.selectAll('line').attr('opacity', d => {
                    // æ ¹æ®è¾¹ç±»å‹è®¾ç½®ä¸åŒçš„é€æ˜åº¦
                    if (d.type === 'post-spread') {
                        return 0.3; // ä¼ æ’­å…³ç³»æ›´é€æ˜
                    } else if (d.type === 'user-post') {
                        return 0.7; // ç”¨æˆ·-å¸–æ–‡å…³ç³»ç¨é€æ˜
                    } else if (d.type === 'post-platform') {
                        return 0.8; // å¸–æ–‡-å¹³å°å…³ç³»è¾ƒæ¸…æ™°
                    }
                    return 0.6; // é»˜è®¤é€æ˜åº¦
                }).attr('stroke-width', d => d.width);
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('weight-slider').addEventListener('input', function() {
                weightThreshold = parseFloat(this.value);
                document.getElementById('weight-value').textContent = weightThreshold.toFixed(2);
                applyFilters();
            });
            
            document.getElementById('show-users').addEventListener('change', function() {
                showUsers = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-posts').addEventListener('change', function() {
                showPosts = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-platforms').addEventListener('change', function() {
                showPlatforms = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-labels').addEventListener('change', function() {
                showLabels = this.checked;
                updateVisualization();
            });
            
            document.getElementById('show-weights').addEventListener('change', function() {
                showWeights = this.checked;
                updateVisualization();
            });
            
            // åŠ è½½æ•°æ®
            loadData();
        });
    </script>
</body>
</html> 