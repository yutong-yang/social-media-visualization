<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á§æ‰∫§Â™í‰Ωì‰º†Êí≠ÁΩëÁªúÂèØËßÜÂåñ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: bold;
            font-size: 12px;
            color: #555;
        }
        
        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .control-btn.active {
            background: #2196F3;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-controls input, .filter-controls select {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .filter-controls label {
            font-size: 12px;
            color: #555;
        }
        

        
        .legend {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            display: inline-block;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .legend-line {
            display: inline-block;
            margin-right: 8px;
            border-radius: 1px;
        }
        
        #network-container {
            width: 100%;
            height: 700px;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: relative;
            background: #fafafa;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
        }
        
        .performance-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .evolution-tree {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .tree-node {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tree-node:hover {
            transform: scale(1.5);
        }
        

        
        .tree-link {
            position: absolute;
            background: #ccc;
            height: 1px;
            transform-origin: left center;
        }
        
        .tree-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
        }
        
        .time-arrow {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 16px;
            color: #666;
            z-index: 100;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .control-group h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        
        .query-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .query-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .query-btn {
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .query-btn:hover {
            background: #45a049;
        }
        
        .query-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border-radius: 4px;
            padding: 8px;
        }
        
        .query-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .query-result {
            background: white;
            padding: 6px;
            margin-bottom: 4px;
            border-radius: 3px;
            border-left: 3px solid #4CAF50;
            font-size: 11px;
        }
        
        .query-result strong {
            color: #333;
        }
        
        .query-result small {
            color: #666;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            padding: 8px 16px;
            background: white;
            color: #555;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            /* border: 1px solid #6aaeae5b; */
        }

        .nav-link:hover {
            background: #99999937;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="background: #f8f9fa; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0; color: #333;">Á§æ‰∫§Â™í‰Ωì‰º†Êí≠ÁΩëÁªúÂèØËßÜÂåñ</h1>
            <nav style="display: flex; gap: 15px;">
                 <a href="index.html" class="nav-link">üè† ‰∏ªÈ°µ</a>
                <a href="data_visualization.html" class="nav-link">üìà Êï∞ÊçÆÂàÜÊûê</a>
            </nav>
        </header>
        
        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="controls-panel">
            <!-- ËßÜÂõæÁ±ªÂûã -->
            <div class="control-group">
                <h4>ËßÜÂõæÁ±ªÂûã</h4>
                <button class="control-btn active" onclick="showView('all')">ÂÖ®ÈÉ®</button>
                <button class="control-btn" onclick="showView('user-post')">Áî®Êà∑-Â∏ñÂ≠ê</button>
                <button class="control-btn" onclick="showView('post-platform')">Â∏ñÂ≠ê-Âπ≥Âè∞</button>
                <button class="control-btn" onclick="showView('post-spread')">‰º†Êí≠ÂÖ≥Á≥ª</button>
            </div>
            
            <!-- ‰º†Êí≠Âº∫Â∫¶ËøáÊª§ -->
            <div class="control-group">
                <h4>‰º†Êí≠Âº∫Â∫¶ËøáÊª§</h4>
                <input type="range" id="weight-slider" min="0" max="0.22" step="0.01" value="0" class="slider">
                <span id="weight-value">0.00</span>
            </div>
            
            <!-- ËäÇÁÇπÁ±ªÂûãËøáÊª§ -->
            <div class="control-group">
                <h4>ËäÇÁÇπÁ±ªÂûãËøáÊª§</h4>
                <label><input type="checkbox" id="show-users" checked> Áî®Êà∑</label>
                <label><input type="checkbox" id="show-posts" checked> Â∏ñÂ≠ê</label>
                <label><input type="checkbox" id="show-platforms" checked> Âπ≥Âè∞</label>
            </div>
            
            <!-- ÊòæÁ§∫ÈÄâÈ°π -->
            <div class="control-group">
                <h4>ÊòæÁ§∫ÈÄâÈ°π</h4>
                <label><input type="checkbox" id="show-labels"> ÊòæÁ§∫Ê†áÁ≠æ</label>
                <label><input type="checkbox" id="show-weights"> ÊòæÁ§∫ÊùÉÈáç</label>
            </div>
            
            <!-- Â∏ÉÂ±ÄÊéßÂà∂ -->
            <div class="control-group">
                <h4>Â∏ÉÂ±ÄÊéßÂà∂</h4>
                <button onclick="resetLayout()" class="control-btn">ÈáçÁΩÆÂ∏ÉÂ±Ä</button>
                <button id="pause-btn" onclick="toggleSimulation()" class="control-btn">ÊöÇÂÅú</button>
            </div>
            
            <!-- Êï∞ÊçÆËøáÊª§ -->
            <div class="control-group">
                <h4>Êï∞ÊçÆËøáÊª§</h4>
                <label><input type="checkbox" id="enable-path-filter" checked> ÂêØÁî®Ë∑ØÂæÑËøáÊª§</label>
                <button onclick="togglePathFilter()" class="control-btn">ÂàáÊç¢ËøáÊª§</button>
            </div>
            
            <!-- ÁΩëÁªú‰ø°ÊÅØ -->
            <div class="control-group">
                <h4>ÁΩëÁªú‰ø°ÊÅØ</h4>
                <div id="network-info" style="font-size: 11px; line-height: 1.3; color: #666;">
                    <div>ËäÇÁÇπÊï∞: <span id="node-count">-</span></div>
                    <div>ËæπÊï∞: <span id="edge-count">-</span></div>
                    <div>ÂΩìÂâçËßÜÂõæ: <span id="current-view">-</span></div>
                    <div>Áî®Êà∑ËäÇÁÇπ: <span id="user-count">-</span></div>
                    <div>Â∏ñÊñáËäÇÁÇπ: <span id="post-count">-</span></div>
                    <div>Âπ≥Âè∞ËäÇÁÇπ: <span id="platform-count">-</span></div>
                    <div>‰º†Êí≠Âº∫Â∫¶ÈòàÂÄº: <span id="threshold-display">0.000</span></div>
                </div>
            </div>
            
            <!-- ËÅöÂêàÊ®°Âºè -->
            <!-- <div class="control-group">
                <h4>ËÅöÂêàÊ®°Âºè</h4>
                <button class="control-btn active" onclick="setAggregationMode('none')">Êó†ËÅöÂêà</button>
                <button class="control-btn" onclick="setAggregationMode('community')">Á§æÂå∫ËÅöÂêà</button>
                <button class="control-btn" onclick="setAggregationMode('platform')">Âπ≥Âè∞ËÅöÂêà</button>
                <button class="control-btn" onclick="setAggregationMode('user')">Áî®Êà∑ËÅöÂêà</button>
                <button class="control-btn" onclick="setAggregationMode('simple')">ÁÆÄÂçïËÅöÂêà</button>
            </div> -->
        </div>
        
        <div style="display: flex; gap: 20px;">
            <div id="network-container" style="flex: 2;">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div id="evolution-tree-container" style="flex: 1; height: 600px; border: 0px solid #ddd; border-radius: 5px; position: relative;">
                    <div class="loading">Âä†ËΩΩÊºîÂåñÊ†ë...</div>
                </div>
                <div id="topic-legend" style="height: 40px; position: relative; background: #f0f0f0; border: 1px solid #ddd; border-top: none; font-size: 11px; padding: 5px;">
                    <!-- ËØùÈ¢òÂõæ‰æãÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
        
        <div class="legend">
            <!-- ËäÇÁÇπÁ±ªÂûãÂõæ‰æã -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ËäÇÁÇπÁ±ªÂûã</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #ff6b6b; width: 10px; height: 10px;"></span>
                        Áî®Êà∑ËäÇÁÇπ (Â∞è)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4ecdc4; width: 8px; height: 8px;"></span>
                        Â∏ñÊñáËäÇÁÇπ (Â∞è)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #45b7d1; width: 20px; height: 20px;"></span>
                        Âπ≥Âè∞ËäÇÁÇπ (Â§ß)
                    </div>
                </div>
            </div>
            
            <!-- Âπ≥Âè∞È¢úËâ≤Âõæ‰æã -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">Âπ≥Âè∞È¢úËâ≤</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4A90E2; width: 15px; height: 15px;"></span>
                        ÂæÆÂçö
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #C3AB32; width: 15px; height: 15px;"></span>
                        ÁΩëÊòìÊñ∞Èóª
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #AC6158; width: 15px; height: 15px;"></span>
                        ÊäñÈü≥
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #AD748C; width: 15px; height: 15px;"></span>
                        ‰ªäÊó•Â§¥Êù°
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #3E5555; width: 15px; height: 15px;"></span>
                        Â∞èÁ∫¢‰π¶
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #E17D66; width: 15px; height: 15px;"></span>
                        ÂæÆ‰ø°
                    </div>
                </div>
            </div>
            
            <!-- ËæπÁ±ªÂûãÂõæ‰æã -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ÂÖ≥Á≥ªÁ±ªÂûã</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="legend-item">
                        <span class="legend-line" style="background: #ff6b6b; width: 20px; height: 2px;"></span>
                        Áî®Êà∑-Â∏ñÊñáÂÖ≥Á≥ª
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #45b7d1; width: 20px; height: 2px;"></span>
                        Â∏ñÊñá-Âπ≥Âè∞ÂÖ≥Á≥ª
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 20px; height: 2px;"></span>
                        ‰º†Êí≠ÂÖ≥Á≥ª
                    </div>
                </div>
            </div>
            
            <!-- ‰º†Êí≠Âº∫Â∫¶Âõæ‰æã -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">‰º†Êí≠Âº∫Â∫¶</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 1px;"></span>
                        Âº±‰º†Êí≠
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 3px;"></span>
                        ‰∏≠Á≠â‰º†Êí≠
                    </div>
                    <div class="legend-item">
                        <span class="legend-line" style="background: #96ceb4; width: 15px; height: 6px;"></span>
                        Âº∫‰º†Êí≠
                    </div>
                </div>
            </div>
        </div>
        

        
        <div class="performance-info" id="performance-info">
            ÊÄßËÉΩ‰ø°ÊÅØ
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let networkData = null;
        let simulation = null;
        let svg = null;
        let currentView = 'all';
        let allNodes = [];
        let allLinks = [];
        let filteredNodes = [];
        let filteredLinks = [];
        let tooltip = null;
        let isSimulationRunning = true;
        
        // ÊºîÂåñÊ†ëÁõ∏ÂÖ≥ÂèòÈáè
        let evolutionData = null;
        let treeContainer = null;
        let treeTooltip = null;
        
        // ËøáÊª§ËÆæÁΩÆ
        let weightThreshold = 0;
        let showUsers = true;
        let showPosts = true;
        let showPlatforms = true;
        let showLabels = false;
        let showWeights = false;
        
        // ËÅöÂêàËÆæÁΩÆ
        // let aggregationMode = 'none'; // 'none', 'community', 'platform', 'user'
        // let aggregatedNodes = new Map();
        // let aggregatedLinks = [];
        
        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            try {
                // È¶ñÂÖàÂä†ËΩΩË∑ØÂæÑÊï∞ÊçÆ
                const pathsResponse = await fetch('./data/4-1data/paths_data.json');
                const pathsData = await pathsResponse.json();
                console.log('Ë∑ØÂæÑÊï∞ÊçÆÂä†ËΩΩÊàêÂäü:', pathsData);
                
                // ÊèêÂèñÊâÄÊúâË∑ØÂæÑ‰∏≠ÁöÑÂ∏ñÊñáID
                const pathPostIds = new Set();
                pathsData.forEach(path => {
                    if (path.Ë∑ØÂæÑ && Array.isArray(path.Ë∑ØÂæÑ)) {
                        path.Ë∑ØÂæÑ.forEach(post => {
                            if (post.Â∏ñÊñáID) {
                                pathPostIds.add(post.Â∏ñÊñáID);
                            }
                        });
                    }
                });
                
                console.log('‰ªéË∑ØÂæÑÊï∞ÊçÆ‰∏≠ÊèêÂèñÁöÑÂ∏ñÊñáIDÊï∞Èáè:', pathPostIds.size);
                console.log('Ë∑ØÂæÑÂ∏ñÊñáIDÁ§∫‰æã:', Array.from(pathPostIds).slice(0, 5));
                
                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                window.pathPostIds = pathPostIds;
                
                // ÂàùÂßãÂåñÊºîÂåñÊ†ë
                initializeEvolutionTree();
                
                // Â§ÑÁêÜÊºîÂåñÊï∞ÊçÆ
                evolutionData = processEvolutionData(pathsData);
                console.log('ÊºîÂåñÊï∞ÊçÆÂ§ÑÁêÜÂÆåÊàê:', {
                    totalPosts: evolutionData.posts.length,
                    totalTopics: evolutionData.topics.size
                });
                
                // ÁªòÂà∂ÊºîÂåñÊ†ë
                drawEvolutionTree(evolutionData);
                
                // ÁîüÊàêËØùÈ¢òÂõæ‰æã
                generateTopicLegend(evolutionData);
                

                
                // Âä†ËΩΩÁΩëÁªúÊï∞ÊçÆ
                const response = await fetch('./data/4-1data/edge_data_complete.json');
                networkData = await response.json();
                console.log('ÁΩëÁªúÊï∞ÊçÆÂä†ËΩΩÊàêÂäü:', networkData);
                
                // ‰º†ÈÄíË∑ØÂæÑÂ∏ñÊñáIDËøõË°åËøáÊª§
                processAllData(pathPostIds);
                initializeVisualization();
            } catch (error) {
                console.error('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                document.getElementById('network-info').innerHTML = 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•';
            }
        }
        
        // Â§ÑÁêÜÊâÄÊúâÊï∞ÊçÆ
        function processAllData(pathPostIds) {
            const nodes = new Map();
            const links = [];
            
            // Â§ÑÁêÜÊâÄÊúâËæπÁ±ªÂûã
            const edgeTypes = {
                'user-post': networkData.edge_index_dict["('user', 'posted', 'post')"],
                'post-platform': networkData.edge_index_dict["('post', 'on_platform', 'platform')"],
                'post-spread': networkData.edge_index_dict["('post', 'spread_to', 'post')"]
            };
            
            const edgeAttrs = {
                'user-post': networkData.edge_attr_dict["('user', 'posted', 'post')"],
                'post-platform': networkData.edge_attr_dict["('post', 'on_platform', 'platform')"],
                'post-spread': networkData.edge_attr_dict["('post', 'spread_to', 'post')"]
            };
            
            console.log('ÂºÄÂßãÂ§ÑÁêÜÊï∞ÊçÆ:', {
                edgeTypes: Object.keys(edgeTypes),
                userPostEdges: edgeTypes['user-post'] ? edgeTypes['user-post'].length : 0,
                postPlatformEdges: edgeTypes['post-platform'] ? edgeTypes['post-platform'].length : 0,
                postSpreadEdges: edgeTypes['post-spread'] ? edgeTypes['post-spread'].length : 0,
                pathPostIdsCount: pathPostIds.size
            });
            
            // Â§ÑÁêÜÊØèÁßçËæπÁ±ªÂûã
            Object.keys(edgeTypes).forEach(type => {
                const edges = edgeTypes[type];
                const attrs = edgeAttrs[type];
                
                if (edges && edges.length >= 2) {
                    // Á¨¨‰∏Ä‰∏™Êï∞ÁªÑÊòØÊ∫êËäÇÁÇπÔºåÁ¨¨‰∫å‰∏™Êï∞ÁªÑÊòØÁõÆÊ†áËäÇÁÇπ
                    const sources = edges[0];
                    const targets = edges[1];
                    
                    console.log(`Â§ÑÁêÜ ${type} Ëæπ:`, {
                        sourcesLength: sources.length,
                        targetsLength: targets.length,
                        attrsLength: attrs ? attrs.length : 0
                    });
                    
                    for (let i = 0; i < Math.min(sources.length, targets.length); i++) {
                        const source = sources[i];
                        const target = targets[i];
                        const weight = attrs[i] || 1;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Ë∑ØÂæÑ‰∏≠ÁöÑÂ∏ñÊñáID
                        let shouldInclude = false;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®Ë∑ØÂæÑËøáÊª§
                        const enableFilter = document.getElementById('enable-path-filter').checked;
                        
                        if (!enableFilter || pathPostIds.size === 0) {
                            // ‰∏çÂêØÁî®ËøáÊª§ÊàñË∑ØÂæÑÊï∞ÊçÆ‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâÊï∞ÊçÆ
                            shouldInclude = true;
                        } else {
                            // ÂêØÁî®Ë∑ØÂæÑËøáÊª§
                            if (type === 'user-post') {
                                // Áî®Êà∑-Â∏ñÂ≠êÂÖ≥Á≥ªÔºöÊ£ÄÊü•Â∏ñÂ≠êÊòØÂê¶Âú®Ë∑ØÂæÑ‰∏≠
                                if (pathPostIds.has(target)) {
                                    shouldInclude = true;
                                    // console.log(`ÂåÖÂê´Ë∑ØÂæÑÂ∏ñÊñá: ${target} (Áî®Êà∑-Â∏ñÂ≠êÂÖ≥Á≥ª)`);
                                }
                            } else if (type === 'post-platform') {
                                // Â∏ñÂ≠ê-Âπ≥Âè∞ÂÖ≥Á≥ªÔºöÊ£ÄÊü•Â∏ñÂ≠êÊòØÂê¶Âú®Ë∑ØÂæÑ‰∏≠
                                if (pathPostIds.has(source)) {
                                    shouldInclude = true;
                                    // console.log(`ÂåÖÂê´Ë∑ØÂæÑÂ∏ñÊñá: ${source} (Â∏ñÂ≠ê-Âπ≥Âè∞ÂÖ≥Á≥ª)`);
                                }
                            } else if (type === 'post-spread') {
                                // Â∏ñÂ≠ê‰º†Êí≠ÂÖ≥Á≥ªÔºöÊ£ÄÊü•Ê∫êÂ∏ñÂ≠êÊàñÁõÆÊ†áÂ∏ñÂ≠êÊòØÂê¶Âú®Ë∑ØÂæÑ‰∏≠
                                if (pathPostIds.has(source) || pathPostIds.has(target)) {
                                    shouldInclude = true;
                                    // console.log(`ÂåÖÂê´Ë∑ØÂæÑÂ∏ñÊñá: ${source} -> ${target} (Â∏ñÂ≠ê‰º†Êí≠ÂÖ≥Á≥ª)`);
                                }
                            }
                        }
                        
                        // Â¶ÇÊûúÂåÖÂê´Ë∑ØÂæÑ‰∏≠ÁöÑÂ∏ñÊñáÔºåÂàôÊ∑ªÂä†ËäÇÁÇπÂíåËæπ
                        if (shouldInclude) {
                            // Ê∑ªÂä†ËäÇÁÇπ
                            if (!nodes.has(source)) {
                                nodes.set(source, createNode(source));
                            }
                            if (!nodes.has(target)) {
                                nodes.set(target, createNode(target));
                            }
                            
                            // Ê∑ªÂä†Ëæπ
                            let linkColor = getLinkColor(type);
                            
                            // Â¶ÇÊûúÊòØË¥¥Êñá-Âπ≥Âè∞ÂÖ≥Á≥ªÔºå‰ΩøÁî®Âπ≥Âè∞È¢úËâ≤
                            if (type === 'post-platform') {
                                const platformId = target; // ÁõÆÊ†áËäÇÁÇπÊòØÂπ≥Âè∞
                                const platformName = extractPlatformFromPlatformId(platformId);
                                linkColor = getPlatformColorForEvolution(platformName);
                            }
                            
                            links.push({
                                source: source,
                                target: target,
                                type: type,
                                weight: weight,
                                color: linkColor,
                                width: getLinkWidth(type, weight)
                            });
                        }
                    }
                }
            });
            
            allNodes = Array.from(nodes.values());
            allLinks = links;
            
            console.log('Â§ÑÁêÜÂÆåÊàê:', {
                totalNodes: allNodes.length,
                totalLinks: allLinks.length,
                pathPostIdsIncluded: allNodes.filter(n => n.type === 'post' && pathPostIds.has(n.id)).length,
                nodeTypes: {
                    user: allNodes.filter(n => n.type === 'user').length,
                    post: allNodes.filter(n => n.type === 'post').length,
                    platform: allNodes.filter(n => n.type === 'platform').length
                },
                linkTypes: {
                    'user-post': allLinks.filter(l => l.type === 'user-post').length,
                    'post-platform': allLinks.filter(l => l.type === 'post-platform').length,
                    'post-spread': allLinks.filter(l => l.type === 'post-spread').length
                }
            });
            
            // ÊòæÁ§∫‰∏Ä‰∫õËäÇÁÇπÁ§∫‰æã
            if (allNodes.length > 0) {
                console.log('ËäÇÁÇπÁ§∫‰æã:');
                allNodes.slice(0, 5).forEach(node => {
                    console.log(`  ${node.id} -> ${node.type} (${node.color})`);
                });
            }
        }
        
        // ÂàõÂª∫ËäÇÁÇπ
        function createNode(id) {
            const nodeType = getNodeType(id);
            const node = {
                id: id,
                name: id,
                shortName: getShortName(id),
                type: nodeType,
                color: getNodeColor(id),
                size: getNodeSize(id)
            };
            
            // Ë∞ÉËØï‰ø°ÊÅØÔºöÊòæÁ§∫ÂâçÂá†‰∏™ËäÇÁÇπÁöÑÁ±ªÂûã
            if (Math.random() < 0.01) { // Âè™ÊòæÁ§∫1%ÁöÑËäÇÁÇπ‰ø°ÊÅØÔºåÈÅøÂÖçÊó•ÂøóËøáÂ§ö
                console.log(`ËäÇÁÇπÁ±ªÂûãÂà§Êñ≠: ${id} -> ${nodeType} (È¢úËâ≤: ${node.color})`);
            }
            
            return node;
        }
        
        // ÂàùÂßãÂåñÂèØËßÜÂåñ
        function initializeVisualization() {
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // ÁßªÈô§Âä†ËΩΩÊèêÁ§∫
            container.querySelector('.loading').remove();
            
            // ÂàõÂª∫SVG
            svg = d3.select('#network-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Ê∑ªÂä†Áº©ÊîæÂäüËÉΩ
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // ÂàõÂª∫‰∏ªÁªÑ
            const g = svg.append('g');
            
            // ÂàõÂª∫Â∑•ÂÖ∑ÊèêÁ§∫
            tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // Â∫îÁî®ËøáÊª§Âπ∂Êõ¥Êñ∞ÊòæÁ§∫
            applyFilters();
        }
        
        // Â∫îÁî®ËøáÊª§
        function applyFilters() {
            // ËøáÊª§ËäÇÁÇπ
            filteredNodes = allNodes.filter(node => {
                if (!showUsers && node.type === 'user') return false;
                if (!showPosts && node.type === 'post') return false;
                if (!showPlatforms && node.type === 'platform') return false;
                return true;
            });
            
            // ËøáÊª§Ëæπ
            filteredLinks = allLinks.filter(link => {
                if (link.type === 'post-spread' && link.weight < weightThreshold) return false;
                return true;
            });
            
            // Ê†πÊçÆÂΩìÂâçËßÜÂõæËøõ‰∏ÄÊ≠•ËøáÊª§Ëæπ
            if (currentView === 'user-post') {
                filteredLinks = filteredLinks.filter(link => link.type === 'user-post');
            } else if (currentView === 'post-platform') {
                filteredLinks = filteredLinks.filter(link => link.type === 'post-platform');
            } else if (currentView === 'post-spread') {
                filteredLinks = filteredLinks.filter(link => link.type === 'post-spread');
            }
            
            // Âè™‰øùÁïôÊúâËøûÊé•ÁöÑËäÇÁÇπÔºà‰ΩÜ‰øùÁïôÂ≠§Á´ãËäÇÁÇπÂ¶ÇÊûúÂÆÉ‰ª¨Ë¢´ÈÄâ‰∏≠Ôºâ
            const connectedNodes = new Set();
            filteredLinks.forEach(link => {
                connectedNodes.add(link.source);
                connectedNodes.add(link.target);
            });
            
            // ‰øùÁïôÊúâËøûÊé•ÁöÑËäÇÁÇπÔºå‰ª•ÂèäÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ≠§Á´ãËäÇÁÇπ
            filteredNodes = filteredNodes.filter(node => {
                return connectedNodes.has(node.id) || 
                       (node.type === 'user' && showUsers) ||
                       (node.type === 'post' && showPosts) ||
                       (node.type === 'platform' && showPlatforms);
            });
            
            console.log('ËøáÊª§Âêé:', {
                nodes: filteredNodes.length,
                links: filteredLinks.length,
                connectedNodes: connectedNodes.size
            });
            
            updateVisualization();
        }
        
        // Êõ¥Êñ∞ÂèØËßÜÂåñ
        function updateVisualization() {
            if (!svg) return;
            
            console.log('Êõ¥Êñ∞ÂèØËßÜÂåñ:', {
                nodes: filteredNodes.length,
                links: filteredLinks.length,
                view: currentView
                // aggregationMode: aggregationMode
            });
            
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Ê∏ÖÈô§Áé∞ÊúâÂÜÖÂÆπ
            svg.selectAll('*').remove();
            
            // ÈáçÊñ∞Ê∑ªÂä†Áº©Êîæ
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            const g = svg.append('g');
            
            // ÂàõÂª∫ÂäõÂØºÂêëÂ∏ÉÂ±Ä
            simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(50))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(20));
            
            // ÁªòÂà∂Ëæπ
            const link = g.append('g')
                .selectAll('line')
                .data(filteredLinks)
                .enter().append('line')
                .attr('stroke', d => d.color)
                .attr('stroke-width', d => d.width)
                .attr('opacity', 0.6);
            
            // ÁªòÂà∂ËäÇÁÇπ
            const node = g.append('g')
                .selectAll('circle')
                .data(filteredNodes)
                .enter().append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => d.color)
                .attr('stroke', d => {
                    // ‰∏∫Âπ≥Âè∞ËäÇÁÇπÊ∑ªÂä†ÁâπÊÆäËæπÊ°Ü
                    if (d.type === 'platform') {
                        if (d.id === 'P_5' || d.id === 'ÂæÆÂçö') {
                            return '#4A90E2'; // ÂæÆÂçöËìùËâ≤ËæπÊ°Ü
                        } else if (d.id === 'P_1' || d.id === 'ÁΩëÊòìÊñ∞Èóª') {
                            return '#C3AB32'; // ÁΩëÊòìÊñ∞ÈóªÈªÑËâ≤ËæπÊ°Ü
                        } else if (d.id === 'P_0' || d.id === 'ÊäñÈü≥') {
                            return '#AC6158'; // ÊäñÈü≥Á∫¢Ëâ≤ËæπÊ°Ü
                        } else if (d.id === 'P_2' || d.id === '‰ªäÊó•Â§¥Êù°') {
                            return '#AD748C'; // ‰ªäÊó•Â§¥Êù°Á¥´Ëâ≤ËæπÊ°Ü
                        } else if (d.id === 'P_4' || d.id === 'Â∞èÁ∫¢‰π¶') {
                            return '#3E5555'; // Â∞èÁ∫¢‰π¶Ê∑±ÁªøËâ≤ËæπÊ°Ü
                        } else if (d.id === 'P_3' || d.id === 'ÂæÆ‰ø°') {
                            return '#E17D66'; // ÂæÆ‰ø°Ê©ôËâ≤ËæπÊ°Ü
                        }
                        return '#333'; // ÂÖ∂‰ªñÂπ≥Âè∞ÈªëËâ≤ËæπÊ°Ü
                    }
                    return '#fff';
                })
                .attr('stroke-width', d => {
                    // ‰∏∫Âπ≥Âè∞ËäÇÁÇπÊ∑ªÂä†Êõ¥Á≤óÁöÑËæπÊ°Ü
                    if (d.type === 'platform') {
                        return 3;
                    }
                    return 2;
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            console.log('ÁªòÂà∂ÁöÑËäÇÁÇπÊï∞:', node.size());
            console.log('ÁªòÂà∂ÁöÑËæπÊï∞:', link.size());
            
            // Ê∑ªÂä†ËäÇÁÇπÊ†áÁ≠æ
            const label = g.append('g')
                .selectAll('text')
                .data(filteredNodes)
                .enter().append('text')
                .text(d => {
                    if (!showLabels) return '';
                    if (d.count && d.count > 1) {
                        return `${d.shortName} (${d.count})`;
                    }
                    return d.shortName;
                })
                .attr('font-size', '10px')
                .attr('fill', '#333')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em');
            
            // Ê∑ªÂä†ËæπÊùÉÈáçÊ†áÁ≠æ
            const weightLabel = g.append('g')
                .selectAll('text')
                .data(showWeights ? filteredLinks.filter(d => d.type === 'post-spread' || d.type.includes('link')) : [])
                .enter().append('text')
                .text(d => {
                    if (d.count && d.count > 1) {
                        return `${d.weight.toFixed(3)} (${d.count})`;
                    }
                    return d.weight.toFixed(3);
                })
                .attr('font-size', '8px')
                .attr('fill', '#666')
                .attr('text-anchor', 'middle');
            
            // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
            node.on('mouseover', function(event, d) {
                d3.select(this).attr('r', d.size * 1.5);
                showTooltip(event, d);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).attr('r', d.size);
                hideTooltip();
            })
            .on('click', function(event, d) {
                // ÁÇπÂáªËäÇÁÇπÊó∂È´ò‰∫ÆÊòæÁ§∫
                highlightNode(d);
            });
            
            // Êõ¥Êñ∞‰ΩçÁΩÆ
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
                
                weightLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);
            });
            
            // Êõ¥Êñ∞‰ø°ÊÅØÈù¢Êùø
            updateNetworkInfo();
            updatePerformanceInfo();
            
            // Êõ¥Êñ∞Âä®ÊÄÅÂõæ‰æã
            updateDynamicLegend();
        }
        
        // Ëé∑ÂèñËäÇÁÇπÁ±ªÂûã
        function getNodeType(id) {
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Âπ≥Âè∞ËäÇÁÇπÔºàP_Ê†ºÂºèÊàñÁ∫ØÂπ≥Âè∞ÂêçÁß∞Ôºâ
            if (id.startsWith('P_') || ['WB', 'WYXW', 'DY', 'JRTT', 'XHS', 'VX', 'ÂæÆÂçö', 'ÁΩëÊòìÊñ∞Èóª', 'ÊäñÈü≥', '‰ªäÊó•Â§¥Êù°', 'Â∞èÁ∫¢‰π¶', 'ÂæÆ‰ø°'].includes(id)) {
                return 'platform';
            }
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Â∏ñÊñáËäÇÁÇπÔºàÊó∂Èó¥Êà≥Ê†ºÂºèÔºâ
            if (id.match(/^(VX|JRTT|WB|DY|XHS|WYXW)_\d{8,}_\d+$/)) {
                return 'post';
            }
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áî®Êà∑ËäÇÁÇπÔºàÁî®Êà∑ÂêçÊ†ºÂºèÔºâ
            if (id.match(/^(VX|JRTT|WB|DY|XHS|WYXW)_.*_\d+$/)) {
                return 'user';
            }
            
            // ÈªòËÆ§ËøîÂõûÁî®Êà∑Á±ªÂûã
            return 'user';
        }
        
        // Ëé∑ÂèñËäÇÁÇπÈ¢úËâ≤
        function getNodeColor(id) {
            const type = getNodeType(id);
            
            // Â¶ÇÊûúÊòØÂπ≥Âè∞ËäÇÁÇπÔºåÊåâÂπ≥Âè∞È¢úËâ≤ÁºñÁ†Å
            if (type === 'platform') {
                const platform = extractPlatformFromPlatformId(id);
                return getPlatformColorForEvolution(platform);
            }
            
            // Â¶ÇÊûúÊòØË¥¥ÊñáËäÇÁÇπÔºåÊ†πÊçÆÂπ≥Âè∞ID‰ΩøÁî®Âπ≥Âè∞È¢úËâ≤
            if (type === 'post') {
                // ‰ªéË¥¥ÊñáID‰∏≠ÊèêÂèñÂπ≥Âè∞‰ø°ÊÅØ
                const platformId = extractPlatformFromPostId(id);
                console.log('Ë¥¥ÊñáËäÇÁÇπÈ¢úËâ≤ËÆæÁΩÆ:', id, '-> platformId:', platformId);
                if (platformId) {
                    const color = getPlatformColor(platformId);
                    console.log('Ë¥¥ÊñáËäÇÁÇπÊúÄÁªàÈ¢úËâ≤:', id, '->', color);
                    return color;
                }
                return '#4ecdc4'; // ÈªòËÆ§È¢úËâ≤
            }
            
            // ÂÖ∂‰ªñËäÇÁÇπÁ±ªÂûã‰øùÊåÅÂéüËâ≤
            switch (type) {
                case 'user': return '#ff6b6b';
                default: return '#95a5a6';
            }
        }
        
        // ‰ªéË¥¥ÊñáIDÊèêÂèñÂπ≥Âè∞ID
        function extractPlatformFromPostId(postId) {
            // Ë¥¥ÊñáIDÊ†ºÂºèÈÄöÂ∏∏ÊòØ: Âπ≥Âè∞‰ª£Á†Å_Êó∂Èó¥Êà≥_Â∫èÂè∑
            // ‰æãÂ¶Ç: DY_202412071736_8, WYXW_202412121506_12
            const parts = postId.split('_');
            if (parts.length >= 1) {
                const platformCode = parts[0];
                // Â∞ÜÂπ≥Âè∞‰ª£Á†ÅÊò†Â∞ÑÂà∞Âπ≥Âè∞ID
                const platformMapping = {
                    'DY': 'P_0',    // ÊäñÈü≥
                    'WYXW': 'P_1',  // ÁΩëÊòìÊñ∞Èóª
                    'JRTT': 'P_2',  // ‰ªäÊó•Â§¥Êù°
                    'VX': 'P_3',    // ÂæÆ‰ø°
                    'XHS': 'P_4',   // Â∞èÁ∫¢‰π¶
                    'WB': 'P_5'     // ÂæÆÂçö
                };
                console.log('platformMapping[platformCode]',platformMapping[platformCode]);
                return platformMapping[platformCode] || null;
            }
            return null;
        }
        
        // ‰ªéÂπ≥Âè∞IDÊèêÂèñÂπ≥Âè∞‰ø°ÊÅØ
        function extractPlatformFromPlatformId(id) {
            // Âπ≥Âè∞IDÊò†Â∞ÑÂÖ≥Á≥ªÔºàÊîØÊåÅP_Ê†ºÂºèÂíåÁÆÄÁü≠‰ª£Âè∑Ôºâ
            const platformMapping = {
                'P_0': 'ÊäñÈü≥',  
                'P_1': 'ÁΩëÊòìÊñ∞Èóª', 
                'P_2': '‰ªäÊó•Â§¥Êù°',  
                'P_3': 'ÂæÆ‰ø°',  
                'P_4': 'Â∞èÁ∫¢‰π¶', 
                'P_5': 'ÂæÆÂçö',   
                'WB': 'ÂæÆÂçö',   
                'WYXW': 'ÁΩëÊòìÊñ∞Èóª',
                'DY': 'ÊäñÈü≥',   
                'JRTT': '‰ªäÊó•Â§¥Êù°',
                'XHS': 'Â∞èÁ∫¢‰π¶', 
                'VX': 'ÂæÆ‰ø°'   
            };
            
            return platformMapping[id] || 'Êú™Áü•Âπ≥Âè∞';
        }
        

        
        // Ëé∑ÂèñËäÇÁÇπÂ§ßÂ∞è
        function getNodeSize(id) {
            const type = getNodeType(id);
            switch (type) {
                case 'user': return 5; 
                case 'post': return 4;
                case 'platform': return 10;
                default: return 4;
            }
        }
        
        // Ëé∑ÂèñÁü≠ÂêçÁß∞
        function getShortName(id) {
            // Â¶ÇÊûúÊòØÂπ≥Âè∞ËäÇÁÇπÔºåËøîÂõûÂÆåÊï¥ÁöÑÂπ≥Âè∞ÂêçÁß∞
            if (getNodeType(id) === 'platform') {
                return extractPlatformFromPlatformId(id);
            }
            
            // ÂÖ∂‰ªñËäÇÁÇπÊåâÂéüÈÄªËæëÂ§ÑÁêÜ
            if (id.length > 12) {
                return id.substring(0, 9) + '...';
            }
            return id;
        }
        
        // Ëé∑ÂèñËæπÈ¢úËâ≤
        function getLinkColor(type) {
            switch (type) {
                case 'user-post': return '#ff6b6b';
                case 'post-platform': return '#45b7d1'; // Ë¥¥Êñá-Âπ≥Âè∞ÂÖ≥Á≥ª‰ΩøÁî®Âπ≥Âè∞È¢úËâ≤
                case 'post-spread': return '#96ceb4';
                default: return '#999';
            }
        }
        
        // Ëé∑ÂèñËæπÂÆΩÂ∫¶
        function getLinkWidth(type, weight) {
            if (type === 'post-spread') {
                return Math.max(1, weight * 20);
            }
            return 2;
        }
        
        // ÊãñÊãΩÂäüËÉΩ
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // Â∑•ÂÖ∑ÊèêÁ§∫
        function showTooltip(event, d) {
            tooltip.transition()
                .duration(200)
                .style('opacity', .9);
            
            let displayName = d.name;
            // Â¶ÇÊûúÊòØÂπ≥Âè∞ËäÇÁÇπÔºåÊòæÁ§∫ÂÆåÊï¥ÁöÑÂπ≥Âè∞ÂêçÁß∞
            if (d.type === 'platform') {
                displayName = extractPlatformFromPlatformId(d.name);
            }
            
            let tooltipContent = `
                <strong>${getNodeTypeName(d.type)}</strong><br>
                ID: ${displayName}<br>
                Á±ªÂûã: ${d.type}
            `;
            
            if (d.count && d.count > 1) {
                tooltipContent += `<br>ÂåÖÂê´ËäÇÁÇπÊï∞: ${d.count}`;
            }
            
            if (d.members && d.members.length > 0) {
                tooltipContent += `<br>ÊàêÂëò: ${d.members.slice(0, 3).join(', ')}`;
                if (d.members.length > 3) {
                    tooltipContent += `... (ÂÖ±${d.members.length}‰∏™)`;
                }
            }
            
            tooltip.html(tooltipContent)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }
        
        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style('opacity', 0);
        }
        
        // È´ò‰∫ÆËäÇÁÇπ
        function highlightNode(selectedNode) {
            // ÈáçÁΩÆÊâÄÊúâËäÇÁÇπÁöÑÊ†∑Âºè
            svg.selectAll('circle').attr('opacity', 0.3);
            
            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑËäÇÁÇπ
            svg.selectAll('circle').filter(d => d.id === selectedNode.id)
                .attr('opacity', 1)
                .attr('r', d => d.size * 2); // ÊîæÂ§ßÈÄâ‰∏≠ÁöÑËäÇÁÇπ
            
            // È´ò‰∫Æ‰∏éÈÄâ‰∏≠ËäÇÁÇπÁõ∏ËøûÁöÑËæπ
            svg.selectAll('line').attr('opacity', 0.1);
            svg.selectAll('line').filter(d => 
                d.source.id === selectedNode.id || d.target.id === selectedNode.id
            ).attr('opacity', 0.8);
            
            // ÊòæÁ§∫ËäÇÁÇπ‰ø°ÊÅØ
            console.log('È´ò‰∫ÆËäÇÁÇπ:', selectedNode);
            
            // 3ÁßíÂêéÊÅ¢Â§çÊâÄÊúâËäÇÁÇπ
            setTimeout(() => {
                svg.selectAll('circle').attr('opacity', 1).attr('r', d => d.size);
                svg.selectAll('line').attr('opacity', 0.6);
            }, 3000);
        }
        
        
        // Êõ¥Êñ∞‰ø°ÊÅØÈù¢Êùø
        function updateNetworkInfo() {
            const userNodes = filteredNodes.filter(n => n.type === 'user').length;
            const postNodes = filteredNodes.filter(n => n.type === 'post').length;
            const platformNodes = filteredNodes.filter(n => n.type === 'platform').length;
            const communityNodes = filteredNodes.filter(n => n.type === 'community').length;
            
            // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÁΩëÁªú‰ø°ÊÅØ
            document.getElementById('node-count').textContent = filteredNodes.length;
            document.getElementById('edge-count').textContent = filteredLinks.length;
            document.getElementById('current-view').textContent = getViewName(currentView);
            document.getElementById('user-count').textContent = userNodes;
            document.getElementById('post-count').textContent = postNodes;
            document.getElementById('platform-count').textContent = platformNodes;
            document.getElementById('threshold-display').textContent = weightThreshold.toFixed(3);
        }
        
        // Ëé∑ÂèñËÅöÂêàÊ®°ÂºèÂêçÁß∞
        function getAggregationModeName(mode) {
            const names = {
                'none': 'Êó†ËÅöÂêà',
                'community': 'Á§æÂå∫ËÅöÂêà',
                'platform': 'Âπ≥Âè∞ËÅöÂêà',
                'user': 'Áî®Êà∑ËÅöÂêà',
                'simple': 'ÁÆÄÂåñËÅöÂêà'
            };
            return names[mode] || mode;
        }
        
        // Êõ¥Êñ∞ÊÄßËÉΩ‰ø°ÊÅØ
        function updatePerformanceInfo() {
            const performanceInfo = document.getElementById('performance-info');
            const fps = Math.round(1000 / (Date.now() - (window.lastTime || Date.now())));
            window.lastTime = Date.now();
            
            performanceInfo.innerHTML = `
                ËäÇÁÇπ: ${filteredNodes.length} | 
                Ëæπ: ${filteredLinks.length}
            `;
        }
        
        // Ëé∑ÂèñËäÇÁÇπÁ±ªÂûã‰∏≠ÊñáÂêçÁß∞
        function getNodeTypeName(type) {
            const names = {
                'user': 'Áî®Êà∑',
                'post': 'Â∏ñÊñá',
                'platform': 'Âπ≥Âè∞',
                'community': 'Á§æÂå∫'
            };
            return names[type] || type;
        }
        
        // Ëé∑ÂèñËßÜÂõæÂêçÁß∞
        function getViewName(view) {
            const names = {
                'all': 'ÂÖ®ÈÉ®ÂÖ≥Á≥ª',
                'user-post': 'Áî®Êà∑-Â∏ñÊñá',
                'post-platform': 'Â∏ñÊñá-Âπ≥Âè∞',
                'post-spread': 'Â∏ñÊñá‰º†Êí≠'
            };
            return names[view] || view;
        }
        
        // ÂàáÊç¢ËßÜÂõæ
        function showView(view) {
            currentView = view;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ÈáçÊñ∞Â∫îÁî®ËøáÊª§ÔºàÂåÖÊã¨ËßÜÂõæËøáÊª§Ôºâ
            applyFilters();
        }
        
        // Êõ¥Êñ∞ÊùÉÈáçËøáÊª§
        function updateWeightFilter() {
            weightThreshold = parseFloat(document.getElementById('weight-slider').value);
            document.getElementById('weight-value').textContent = weightThreshold.toFixed(2);
            applyFilters();
        }
        
        // Êõ¥Êñ∞ËäÇÁÇπËøáÊª§
        function updateNodeFilter() {
            showUsers = document.getElementById('show-users').checked;
            showPosts = document.getElementById('show-posts').checked;
            showPlatforms = document.getElementById('show-platforms').checked;
            applyFilters();
        }
        
        // Êõ¥Êñ∞Ê†áÁ≠æÊòæÁ§∫
        function updateLabels() {
            showLabels = document.getElementById('show-labels').checked;
            updateVisualization();
        }
        
        // Êõ¥Êñ∞ÊùÉÈáçÊòæÁ§∫
        function updateWeights() {
            showWeights = document.getElementById('show-weights').checked;
            updateVisualization();
        }

        // Êõ¥Êñ∞ËÅöÂêàËÆ°Êï∞ÊòæÁ§∫
        // function updateCounts() {
        //     const showCounts = document.getElementById('show-counts').checked;
        //     if (showCounts && aggregationMode !== 'none') {
        //         // Ê†πÊçÆËÅöÂêàÊ®°ÂºèÂ§ÑÁêÜÊï∞ÊçÆ
        //         const { aggregatedNodes: nodes, aggregatedLinks: links } = aggregateData();
        //         filteredNodes = nodes;
        //         filteredLinks = links;
        //     } else {
        //         // ÂèñÊ∂àËÅöÂêàÔºåÊÅ¢Â§çÂéüÂßãÊï∞ÊçÆ
        //         applyFilters();
        //         return;
        //     }
        //     updateVisualization();
        // }
        
        // ËÅöÂêàÊï∞ÊçÆ
        // function aggregateData() {
        //     const aggregatedNodes = new Map();
        //     const aggregatedLinks = [];
        //     
        //     if (aggregationMode === 'community') {
        //         return aggregateByCommunity();
        //     } else if (aggregationMode === 'platform') {
        //         return aggregateByPlatform();
        //     } else if (aggregationMode === 'user') {
        //         return aggregateByUser();
        //     } else if (aggregationMode === 'simple') {
        //         return aggregateBySimple();
        //     }
        //     
        //     return { aggregatedNodes: [], aggregatedLinks: [] };
        // }
        
        // ÊåâÁ§æÂå∫ËÅöÂêà
        function aggregateByCommunity() {
            const communities = new Map();
            const communityLinks = new Map();
            
            // Ê£ÄÊµãÁ§æÂå∫ÔºàÂü∫‰∫éËøûÊé•Â∫¶Ôºâ
            const nodeCommunities = detectCommunities(filteredNodes, filteredLinks);
            
            // ËÅöÂêàËäÇÁÇπ
            filteredNodes.forEach(node => {
                const communityId = nodeCommunities.get(node.id) || 'community_' + node.id.split('_')[0];
                if (!communities.has(communityId)) {
                    communities.set(communityId, {
                        id: communityId,
                        name: `Á§æÂå∫ ${communityId}`,
                        shortName: `Á§æÂå∫${communityId}`,
                        type: 'community',
                        color: getCommunityColor(communityId),
                        size: 12,
                        count: 0,
                        members: []
                    });
                }
                const community = communities.get(communityId);
                community.count++;
                community.members.push(node.id);
            });
            
            // ËÅöÂêàËæπ
            filteredLinks.forEach(link => {
                const sourceCommunity = nodeCommunities.get(link.source) || 'community_' + link.source.split('_')[0];
                const targetCommunity = nodeCommunities.get(link.target) || 'community_' + link.target.split('_')[0];
                
                if (sourceCommunity !== targetCommunity) {
                    const linkKey = `${sourceCommunity}-${targetCommunity}`;
                    if (!communityLinks.has(linkKey)) {
                        communityLinks.set(linkKey, {
                            source: communities.get(sourceCommunity),
                            target: communities.get(targetCommunity),
                            type: 'community-link',
                            weight: 0,
                            count: 0,
                            color: '#808080',
                            width: 2
                        });
                    }
                    const communityLink = communityLinks.get(linkKey);
                    communityLink.weight += link.weight;
                    communityLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(communities.values()),
                aggregatedLinks: Array.from(communityLinks.values())
            };
        }
        
        // ÊåâÂπ≥Âè∞ËÅöÂêà
        function aggregateByPlatform() {
            const platforms = new Map();
            const platformLinks = new Map();
            
            // ËÅöÂêàËäÇÁÇπ
            filteredNodes.forEach(node => {
                const platformId = extractPlatform(node.id);
                if (!platforms.has(platformId)) {
                    platforms.set(platformId, {
                        id: platformId,
                        name: platformId,
                        shortName: platformId,
                        type: 'platform',
                        color: getPlatformColorForEvolution(platformId),
                        size: 10,
                        count: 0,
                        members: []
                    });
                }
                const platform = platforms.get(platformId);
                platform.count++;
                platform.members.push(node.id);
            });
            
            // ËÅöÂêàËæπ
            filteredLinks.forEach(link => {
                const sourcePlatform = extractPlatform(link.source);
                const targetPlatform = extractPlatform(link.target);
                
                if (sourcePlatform !== targetPlatform) {
                    const linkKey = `${sourcePlatform}-${targetPlatform}`;
                    if (!platformLinks.has(linkKey)) {
                        platformLinks.set(linkKey, {
                            source: platforms.get(sourcePlatform),
                            target: platforms.get(targetPlatform),
                            type: 'platform-link',
                            weight: 0,
                            count: 0,
                            color: '#45b7d1',
                            width: 2
                        });
                    }
                    const platformLink = platformLinks.get(linkKey);
                    platformLink.weight += link.weight;
                    platformLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(platforms.values()),
                aggregatedLinks: Array.from(platformLinks.values())
            };
        }
        
        // ÊåâÁî®Êà∑ËÅöÂêà
        function aggregateByUser() {
            const users = new Map();
            const userLinks = new Map();
            
            // ËÅöÂêàËäÇÁÇπ
            filteredNodes.forEach(node => {
                const userId = extractUser(node.id);
                if (!users.has(userId)) {
                    users.set(userId, {
                        id: userId,
                        name: userId,
                        shortName: userId,
                        type: 'user',
                        color: '#ff6b6b',
                        size: 8,
                        count: 0,
                        members: []
                    });
                }
                const user = users.get(userId);
                user.count++;
                user.members.push(node.id);
            });
            
            // ËÅöÂêàËæπ
            filteredLinks.forEach(link => {
                const sourceUser = extractUser(link.source);
                const targetUser = extractUser(link.target);
                
                if (sourceUser !== targetUser) {
                    const linkKey = `${sourceUser}-${targetUser}`;
                    if (!userLinks.has(linkKey)) {
                        userLinks.set(linkKey, {
                            source: users.get(sourceUser),
                            target: users.get(targetUser),
                            type: 'user-link',
                            weight: 0,
                            count: 0,
                            color: '#ff6b6b',
                            width: 2
                        });
                    }
                    const userLink = userLinks.get(linkKey);
                    userLink.weight += link.weight;
                    userLink.count++;
                }
            });
            
            return {
                aggregatedNodes: Array.from(users.values()),
                aggregatedLinks: Array.from(userLinks.values())
            };
        }

        // ÁÆÄÂåñËÅöÂêà (‰ªÖÁî®‰∫éÂ§ßÈáèÊï∞ÊçÆ)
        function aggregateBySimple() {
            const aggregatedNodes = new Map();
            const aggregatedLinks = [];

            // ËÅöÂêàËäÇÁÇπ
            filteredNodes.forEach(node => {
                const id = node.id;
                if (!aggregatedNodes.has(id)) {
                    aggregatedNodes.set(id, {
                        id: id,
                        name: id,
                        shortName: getShortName(id),
                        type: getNodeType(id),
                        color: getNodeColor(id),
                        size: getNodeSize(id),
                        count: 0,
                        members: []
                    });
                }
                const aggNode = aggregatedNodes.get(id);
                aggNode.count++;
                aggNode.members.push(id);
            });

            // ËÅöÂêàËæπ
            filteredLinks.forEach(link => {
                const source = link.source;
                const target = link.target;
                const weight = link.weight;

                if (!aggregatedNodes.has(source) || !aggregatedNodes.has(target)) {
                    // Â¶ÇÊûúÊ∫êÊàñÁõÆÊ†áËäÇÁÇπÊú™ËÅöÂêàÔºåÂàôË∑≥ËøáËØ•Ëæπ
                    return;
                }

                const sourceAgg = aggregatedNodes.get(source);
                const targetAgg = aggregatedNodes.get(target);

                if (sourceAgg.type === targetAgg.type) { // ÂêåÁ±ªËäÇÁÇπËÅöÂêà
                    const linkKey = `${sourceAgg.id}-${targetAgg.id}`;
                    if (!aggregatedLinks.some(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id)) {
                        aggregatedLinks.push({
                            source: sourceAgg,
                            target: targetAgg,
                            type: 'simple-link', // ÁÆÄÂåñËÅöÂêàËæπ
                            weight: 0,
                            count: 0,
                            color: getLinkColor(link.type), // ‰ΩøÁî®ÂéüÂßãËæπÈ¢úËâ≤
                            width: getLinkWidth(link.type, weight)
                        });
                    }
                    const simpleLink = aggregatedLinks.find(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id);
                    simpleLink.weight += weight;
                    simpleLink.count++;
                } else { // ‰∏çÂêåÁ±ªËäÇÁÇπËÅöÂêà
                    const linkKey = `${sourceAgg.id}-${targetAgg.id}`;
                    if (!aggregatedLinks.some(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id)) {
                        aggregatedLinks.push({
                            source: sourceAgg,
                            target: targetAgg,
                            type: 'simple-link', // ÁÆÄÂåñËÅöÂêàËæπ
                            weight: 0,
                            count: 0,
                            color: '#808080', // ËÅöÂêàËæπÈ¢úËâ≤
                            width: 2
                        });
                    }
                    const simpleLink = aggregatedLinks.find(aggLink => aggLink.source.id === sourceAgg.id && aggLink.target.id === targetAgg.id);
                    simpleLink.weight += weight;
                    simpleLink.count++;
                }
            });

            return {
                aggregatedNodes: Array.from(aggregatedNodes.values()),
                aggregatedLinks: aggregatedLinks
            };
        }
        
        // Á§æÂå∫Ê£ÄÊµãÁÆóÊ≥ïÔºàÁÆÄÂåñÁâàÔºâ
        function detectCommunities(nodes, links) {
            const nodeCommunities = new Map();
            const visited = new Set();
            let communityId = 0;
            
            // ‰∏∫ÊØè‰∏™ËäÇÁÇπÂàÜÈÖçÁ§æÂå∫
            nodes.forEach(node => {
                if (!visited.has(node.id)) {
                    const community = new Set();
                    dfs(node.id, links, visited, community);
                    
                    // ‰∏∫Á§æÂå∫ÂàÜÈÖçID
                    community.forEach(nodeId => {
                        nodeCommunities.set(nodeId, communityId);
                    });
                    communityId++;
                }
            });
            
            return nodeCommunities;
        }
        
        // Ê∑±Â∫¶‰ºòÂÖàÊêúÁ¥¢
        function dfs(nodeId, links, visited, community) {
            visited.add(nodeId);
            community.add(nodeId);
            
            // Êü•ÊâæËøûÊé•ÁöÑËäÇÁÇπ
            links.forEach(link => {
                if (link.source === nodeId && !visited.has(link.target)) {
                    dfs(link.target, links, visited, community);
                }
                if (link.target === nodeId && !visited.has(link.source)) {
                    dfs(link.source, links, visited, community);
                }
            });
        }
        
        // ÊèêÂèñÂπ≥Âè∞‰ø°ÊÅØ
        function extractPlatform(nodeId) {
            const parts = nodeId.split('_');
            if (parts.length > 0) {
                return parts[0];
            }
            return 'unknown';
        }
        
        // ÊèêÂèñÁî®Êà∑‰ø°ÊÅØ
        function extractUser(nodeId) {
            const parts = nodeId.split('_');
            if (parts.length > 1) {
                return parts[1];
            }
            return nodeId;
        }
        
        // Ëé∑ÂèñÁ§æÂå∫È¢úËâ≤
        function getCommunityColor(communityId) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
            const index = parseInt(communityId.toString().replace(/\D/g, '')) % colors.length;
            return colors[index];
        }
        
        // Ëé∑ÂèñÂπ≥Âè∞È¢úËâ≤
        function getPlatformColor(platformId) {
            const platformColors = {
                'P_5': '#4A90E2', // ÂæÆÂçöËìùËâ≤
                'P_1': '#C3AB32', // ÁΩëÊòìÊñ∞ÈóªÈªÑËâ≤
                'P_0': '#AC6158', // ÊäñÈü≥Á∫¢Ëâ≤
                'P_2': '#AD748C', // ‰ªäÊó•Â§¥Êù°Á¥´Ëâ≤
                'P_4': '#3E5555', // Â∞èÁ∫¢‰π¶Ê∑±ÁªøËâ≤
                'P_3': '#E17D66', // ÂæÆ‰ø°Ê©ôËâ≤
                'ÂæÆÂçö': '#4A90E2',
                'ÂæÆ‰ø°': '#E17D66',
                'ÊäñÈü≥': '#AC6158',
                '‰ªäÊó•Â§¥Êù°': '#AD748C',
                'Â∞èÁ∫¢‰π¶': '#3E5555',
                'ÁΩëÊòìÊñ∞Èóª': '#C3AB32'
            };
            console.log('getPlatformColor ËæìÂÖ•:', platformId);
            console.log('platformColors[platformId]:', platformColors[platformId]);
            const result = platformColors[platformId] || '#808080';
            console.log('getPlatformColor ËæìÂá∫:', result);
            return result;
        }
        
        // ÂàáÊç¢Ë∑ØÂæÑËøáÊª§
        function togglePathFilter() {
            const enableFilter = document.getElementById('enable-path-filter').checked;
            console.log('Ë∑ØÂæÑËøáÊª§Áä∂ÊÄÅ:', enableFilter);
            
            // ÈáçÊñ∞Â§ÑÁêÜÊï∞ÊçÆ
            if (networkData) {
                if (enableFilter && window.pathPostIds) {
                    processAllData(window.pathPostIds);
                } else {
                    processAllData(new Set()); // Á©∫ÈõÜÂêàË°®Á§∫‰∏çËøáÊª§
                }
                applyFilters();
            }
        }
        
        // ËÆæÁΩÆËÅöÂêàÊ®°Âºè
        // function setAggregationMode(mode) {
        //     aggregationMode = mode;
        //     document.querySelectorAll('.control-btn').forEach(btn => {
        //         btn.classList.remove('active');
        //     });
        //     document.querySelector(`.control-btn[onclick="setAggregationMode('${mode}')"]`).classList.add('active');
        //     updateCounts(); // Â∫îÁî®Êñ∞ÁöÑËÅöÂêàÊ®°Âºè
        // }
        
        // ÈáçÁΩÆÂ∏ÉÂ±Ä
        function resetLayout() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }
        
        // ÂàáÊç¢Ê®°Êãü
        function toggleSimulation() {
            if (simulation) {
                if (isSimulationRunning) {
                    simulation.stop();
                } else {
                    simulation.alpha(1).restart();
                }
                isSimulationRunning = !isSimulationRunning;
            }
        }
        
        // Áü•ËØÜÂõæË∞±Êü•ËØ¢ÂäüËÉΩ
        function searchNode() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;
            
            const results = [];
            
            // ÊêúÁ¥¢ËäÇÁÇπ
            allNodes.forEach(node => {
                if (node.id.toLowerCase().includes(query.toLowerCase()) ||
                    node.name.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'node',
                        data: node,
                        match: node.id.includes(query) ? 'exact' : 'partial'
                    });
                }
            });
            
            // ÊêúÁ¥¢Ëæπ
            allLinks.forEach(link => {
                if (link.source.toLowerCase().includes(query.toLowerCase()) ||
                    link.target.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'link',
                        data: link,
                        match: 'related'
                    });
                }
            });
            
            displayQueryResults(results, `ÊêúÁ¥¢ "${query}" ÁöÑÁªìÊûú`);
        }
        
        function findPath() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;
            
            const parts = query.split('->');
            if (parts.length !== 2) {
                displayQueryResults([], 'ËØ∑ËæìÂÖ•Ê†ºÂºè: ËäÇÁÇπA->ËäÇÁÇπB');
                return;
            }
            
            const source = parts[0].trim();
            const target = parts[1].trim();
            
            // ÁÆÄÂçïÁöÑË∑ØÂæÑÊü•ÊâæÔºàBFSÔºâ
            const path = findShortestPath(source, target);
            
            if (path) {
                displayQueryResults([{
                    type: 'path',
                    data: path,
                    match: 'exact'
                }], `‰ªé ${source} Âà∞ ${target} ÁöÑË∑ØÂæÑ`);
            } else {
                displayQueryResults([], `Êú™ÊâæÂà∞‰ªé ${source} Âà∞ ${target} ÁöÑË∑ØÂæÑ`);
            }
        }
        
        function findInfluencers() {
            // Êü•ÊâæÂΩ±ÂìçÂäõÊúÄÂ§ßÁöÑËäÇÁÇπ
            const influenceMap = new Map();
            
            // ËÆ°ÁÆóÂÖ•Â∫¶ÔºàË¢´‰º†Êí≠Ê¨°Êï∞Ôºâ
            allLinks.forEach(link => {
                if (link.type === 'post-spread') {
                    const target = link.target;
                    influenceMap.set(target, (influenceMap.get(target) || 0) + link.weight);
                }
            });
            
            // ÊéíÂ∫èÂπ∂ÂèñÂâç10‰∏™
            const topInfluencers = Array.from(influenceMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([nodeId, influence]) => ({
                    type: 'influencer',
                    data: { id: nodeId, influence: influence },
                    match: 'top'
                }));
            
            displayQueryResults(topInfluencers, 'ÂΩ±ÂìçÂäõÊúÄÂ§ßÁöÑËäÇÁÇπÔºàÊåâ‰º†Êí≠Âº∫Â∫¶ÊéíÂ∫èÔºâ');
        }
        
        function findShortestPath(source, target) {
            // ÊûÑÂª∫ÈÇªÊé•Ë°®
            const graph = new Map();
            allLinks.forEach(link => {
                if (!graph.has(link.source)) graph.set(link.source, []);
                if (!graph.has(link.target)) graph.set(link.target, []);
                graph.get(link.source).push(link.target);
            });
            
            // BFSÊü•ÊâæÊúÄÁü≠Ë∑ØÂæÑ
            const queue = [[source]];
            const visited = new Set([source]);
            
            while (queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                if (current === target) {
                    return path;
                }
                
                const neighbors = graph.get(current) || [];
                for (const neighbor of neighbors) {
                    if (!visited.has(neighbor)) {
                        visited.add(neighbor);
                        queue.push([...path, neighbor]);
                    }
                }
            }
            
            return null;
        }
        
        function displayQueryResults(results, title) {
            const resultsDiv = document.getElementById('query-results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="query-result">${title}: Êó†ÁªìÊûú</div>`;
                return;
            }
            
            let html = `<div class="query-title">${title} (${results.length}‰∏™ÁªìÊûú)</div>`;
            
            results.forEach(result => {
                switch (result.type) {
                    case 'node':
                        html += `<div class="query-result">
                            <strong>ËäÇÁÇπ:</strong> ${result.data.id}<br>
                            <small>Á±ªÂûã: ${result.data.type}</small>
                        </div>`;
                        break;
                    case 'link':
                        html += `<div class="query-result">
                            <strong>Ëæπ:</strong> ${result.data.source} ‚Üí ${result.data.target}<br>
                            <small>Á±ªÂûã: ${result.data.type}, ÊùÉÈáç: ${result.data.weight.toFixed(3)}</small>
                        </div>`;
                        break;
                    case 'path':
                        html += `<div class="query-result">
                            <strong>Ë∑ØÂæÑ:</strong> ${result.data.join(' ‚Üí ')}<br>
                            <small>ÈïøÂ∫¶: ${result.data.length - 1} Ë∑≥</small>
                        </div>`;
                        break;
                    case 'influencer':
                        html += `<div class="query-result">
                            <strong>ÂΩ±ÂìçÂäõËäÇÁÇπ:</strong> ${result.data.id}<br>
                            <small>‰º†Êí≠Âº∫Â∫¶: ${result.data.influence.toFixed(3)}</small>
                        </div>`;
                        break;
                }
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // È´ò‰∫ÆÊü•ËØ¢ÁªìÊûú
        function highlightQueryResults(results) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
            svg.selectAll('circle').attr('stroke', '#fff').attr('stroke-width', 2);
            svg.selectAll('line').attr('stroke-width', d => d.width);
            
            if (!results || results.length === 0) return;
            
            // È´ò‰∫ÆÁõ∏ÂÖ≥ËäÇÁÇπÂíåËæπ
            results.forEach(result => {
                if (result.type === 'node') {
                    svg.selectAll('circle').filter(d => d.id === result.data.id)
                        .attr('stroke', '#ff0000').attr('stroke-width', 4);
                } else if (result.type === 'link') {
                    svg.selectAll('line').filter(d => 
                        d.source === result.data.source && d.target === result.data.target)
                        .attr('stroke-width', d => d.width * 2);
                }
            });
        }
        
        // ÂàùÂßãÂåñÊºîÂåñÊ†ë
        function initializeEvolutionTree() {
            treeContainer = document.getElementById('evolution-tree-container');
            treeContainer.querySelector('.loading').remove();
            
            // ÂàõÂª∫ÊºîÂåñÊ†ëÂÆπÂô®
            const treeDiv = document.createElement('div');
            treeDiv.className = 'evolution-tree';
            treeContainer.appendChild(treeDiv);
            
            // ÂàõÂª∫Â∑•ÂÖ∑ÊèêÁ§∫
            treeTooltip = document.createElement('div');
            treeTooltip.className = 'tree-tooltip';
            treeTooltip.style.opacity = '0';
            document.body.appendChild(treeTooltip);
        }
        
        // Â§ÑÁêÜÊºîÂåñÊï∞ÊçÆ
        function processEvolutionData(pathsData) {
            const allPosts = [];
            
            // ÊèêÂèñÊâÄÊúâÂ∏ñÂ≠êÂπ∂ÊåâÊó∂Èó¥ÊéíÂ∫è
            pathsData.forEach(path => {
                if (path.Ë∑ØÂæÑ && Array.isArray(path.Ë∑ØÂæÑ)) {
                    path.Ë∑ØÂæÑ.forEach(post => {
                        if (post.Â∏ñÊñáID && post.Êó∂Èó¥) {
                            allPosts.push({
                                id: post.Â∏ñÊñáID,
                                time: new Date(post.Êó∂Èó¥),
                                platform: post.Âπ≥Âè∞,
                                topicId: path.ËØùÈ¢òÁºñÂè∑ || 0
                            });
                        }
                    });
                }
            });
            
            // ÊåâÊó∂Èó¥ÊéíÂ∫è
            allPosts.sort((a, b) => a.time - b.time);
            
            // Êåâ‰∏ªÈ¢òÂàÜÁªÑ
            const topics = new Map();
            allPosts.forEach(post => {
                if (!topics.has(post.topicId)) {
                    topics.set(post.topicId, []);
                }
                topics.get(post.topicId).push(post);
            });
            
            // ËØÜÂà´ÂÖ≥ÈîÆËäÇÁÇπ
            const keyNodes = identifyKeyNodes(allPosts);
            
            // ËÆ°ÁÆóÁÉ≠Â∫¶
            const heatMap = calculateHeatMap(allPosts);
            
            return {
                posts: allPosts,
                topics: topics,
                keyNodes: keyNodes,
                heatMap: heatMap
            };
        }
        
        // ËØÜÂà´ÂÖ≥ÈîÆËäÇÁÇπ
        function identifyKeyNodes(posts) {
            const keyNodes = new Set();
            
            // Á¨¨‰∏Ä‰∏™Â∏ñÂ≠ê‰Ωú‰∏∫Ê†πËäÇÁÇπ
            if (posts.length > 0) {
                keyNodes.add(posts[0].id);
            }
            
            // ËØÜÂà´Âπ≥Âè∞ËΩ¨Êç¢ËäÇÁÇπÔºàÂΩìËØùÈ¢ò‰ªé‰∏Ä‰∏™Âπ≥Âè∞‰º†Êí≠Âà∞Âè¶‰∏Ä‰∏™Âπ≥Âè∞Êó∂Ôºâ
            for (let i = 1; i < posts.length; i++) {
                const currentPost = posts[i];
                const prevPost = posts[i - 1];
                
                // Â¶ÇÊûúÂπ≥Âè∞ÂèëÁîüÂèòÂåñÔºåÊ†áËÆ∞‰∏∫ÂÖ≥ÈîÆËäÇÁÇπ
                if (currentPost.platform !== prevPost.platform) {
                    keyNodes.add(currentPost.id);
                }
            }
            
            // ÊØè‰∏™‰∏ªÈ¢òÁöÑÊúÄÂêé‰∏Ä‰∏™Â∏ñÂ≠ê‰Ωú‰∏∫Âè∂Â≠êËäÇÁÇπ
            const topicLastPosts = new Map();
            posts.forEach(post => {
                if (!topicLastPosts.has(post.topicId) || 
                    post.time > topicLastPosts.get(post.topicId).time) {
                    topicLastPosts.set(post.topicId, post);
                }
            });
            
            topicLastPosts.forEach(post => {
                keyNodes.add(post.id);
            });
            
            return keyNodes;
        }
        
        // ËÆ°ÁÆóÁÉ≠Â∫¶Êò†Â∞Ñ
        function calculateHeatMap(posts) {
            const heatMap = new Map();
            
            // ÊåâÊó∂Èó¥Á™óÂè£ËÆ°ÁÆóÁÉ≠Â∫¶
            const timeWindows = new Map();
            const windowSize = 60 * 60 * 1000; // 1Â∞èÊó∂Á™óÂè£
            
            posts.forEach(post => {
                const windowKey = Math.floor(post.time.getTime() / windowSize);
                if (!timeWindows.has(windowKey)) {
                    timeWindows.set(windowKey, []);
                }
                timeWindows.get(windowKey).push(post);
            });
            
            // ËÆ°ÁÆóÊØè‰∏™Â∏ñÂ≠êÁöÑÁÉ≠Â∫¶ÔºàÂü∫‰∫éÊó∂Èó¥Á™óÂè£ÂÜÖÁöÑÂ∏ñÂ≠êÊï∞ÈáèÔºâ
            posts.forEach(post => {
                const windowKey = Math.floor(post.time.getTime() / windowSize);
                const windowPosts = timeWindows.get(windowKey) || [];
                const heat = windowPosts.length;
                heatMap.set(post.id, heat);
            });
            
            return heatMap;
        }
        
        // Ëé∑ÂèñÂπ≥Âè∞È¢úËâ≤ÔºàÁî®‰∫éÊºîÂåñÊ†ëÔºâ
        function getPlatformColorForEvolution(platform) {
            const colors = {
                'DY': '#AC6158',    // ÊäñÈü≥
                'XHS': '#3E5555',   // Â∞èÁ∫¢‰π¶
                'WYXW': '#C3AB32',  // ÁΩëÊòìÊñ∞Èóª
                'JRTT': '#AD748C',  // ‰ªäÊó•Â§¥Êù°
                'VX': '#E17D66',    // ÂæÆ‰ø°
                'WB': '#4A90E2',    // ÂæÆÂçö
                'ÊäñÈü≥': '#AC6158',    // ÊäñÈü≥
                'Â∞èÁ∫¢‰π¶': '#3E5555',   // Â∞èÁ∫¢‰π¶
                'ÁΩëÊòìÊñ∞Èóª': '#C3AB32',  // ÁΩëÊòìÊñ∞Èóª
                '‰ªäÊó•Â§¥Êù°': '#AD748C',  // ‰ªäÊó•Â§¥Êù°
                'ÂæÆ‰ø°': '#E17D66',    // ÂæÆ‰ø°
                'ÂæÆÂçö': '#4A90E2'     // ÂæÆÂçö
            };
            return colors[platform] || '#95a5a6';
        }
        
        // ÁîüÊàêËØùÈ¢òÂõæ‰æã
        function generateTopicLegend(evolutionData) {
            const legendContainer = document.getElementById('topic-legend');
            const treeContainer = document.getElementById('evolution-tree-container');
            // ‰ΩøÁî®‰∏éÊºîÂåñÊ†ëÁõ∏ÂêåÁöÑÊéíÂ∫èÊñπÂºè
            const topics = Array.from(evolutionData.topics.keys()).sort((a, b) => a - b);
            
            legendContainer.innerHTML = '';
            
            // ‰ΩøÁî®‰∏éÊºîÂåñÊ†ëÂÆåÂÖ®Áõ∏ÂêåÁöÑËÆ°ÁÆóÊñπÂºè
            const topicIds = topics;
            // ‰ΩøÁî®ÊºîÂåñÊ†ëÂÆπÂô®ÁöÑÂÆΩÂ∫¶ÔºåÁ°Æ‰øùÂÆåÂÖ®ÂØπÂ∫î
            const width = treeContainer.clientWidth;
            const margin = 20;
            const topicScale = (width - 2 * margin) / Math.max(topicIds.length, 1);
            
            topics.forEach((topicId) => {
                const legendItem = document.createElement('div');
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.gap = '3px';
                legendItem.style.position = 'absolute';
                legendItem.style.top = '50%';
                legendItem.style.transform = 'translateY(-50%)';
                // ‰ΩøÁî®‰∏éÊºîÂåñÊ†ëÂÆåÂÖ®Áõ∏ÂêåÁöÑxÂùêÊ†áËÆ°ÁÆóÊñπÂºè
                const x = margin + (topicIds.indexOf(topicId) * topicScale);
                legendItem.style.left = x + 'px';
                
                const topicDot = document.createElement('div');
                topicDot.style.width = '6px';
                topicDot.style.height = '6px';
                topicDot.style.borderRadius = '50%';
                topicDot.style.backgroundColor = '#666';
                topicDot.style.border = '1px solid #999';
                
                const label = document.createElement('span');
                label.textContent = `${topicId}`;
                label.style.fontSize = '9px';
                label.style.color = '#666';
                
                legendItem.appendChild(topicDot);
                legendItem.appendChild(label);
                legendContainer.appendChild(legendItem);
            });
        }
        

        
        // ÁªòÂà∂ÊºîÂåñÊ†ë
        function drawEvolutionTree(evolutionData) {
            const container = document.getElementById('evolution-tree-container');
            const treeDiv = container.querySelector('.evolution-tree');
            treeDiv.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = 20;
            
            const posts = evolutionData.posts;
            const topics = evolutionData.topics;
            const keyNodes = evolutionData.keyNodes;
            const heatMap = evolutionData.heatMap;
            
            if (posts.length === 0) {
                treeDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                return;
            }
            
            // ËÆ°ÁÆóÊó∂Èó¥ËåÉÂõ¥
            const timeRange = posts[posts.length - 1].time - posts[0].time;
            const timeScale = (height - 2 * margin) / timeRange;
            
            // ËÆ°ÁÆó‰∏ªÈ¢ò‰ΩçÁΩÆ
            const topicIds = Array.from(topics.keys());
            const topicScale = (width - 2 * margin) / Math.max(topicIds.length, 1);
            
            // ÁªòÂà∂ËäÇÁÇπÂíåËøûÊé•
            const topicPositions = new Map();
            const platformChanges = new Set();
            
            // Ê∑ªÂä†Êó∂Èó¥ÊñπÂêëÁÆ≠Â§¥
            const timeArrow = document.createElement('div');
            timeArrow.className = 'time-arrow';
            timeArrow.innerHTML = '‚¨ÜÔ∏è Êó∂Èó¥';
            treeDiv.appendChild(timeArrow);
            
            posts.forEach((post, index) => {
                const x = margin + (topicIds.indexOf(post.topicId) * topicScale);
                // ‰ΩøÁî®Á¥¢ÂºïËÄå‰∏çÊòØÊó∂Èó¥Êù•ËÆ°ÁÆóY‰ΩçÁΩÆÔºåÁ°Æ‰øùÈó¥Èöî‰∏ÄËá¥
                const y = height - margin - (index * (height - 2 * margin) / (posts.length - 1));
                
                // ÂàõÂª∫ËäÇÁÇπ
                const node = document.createElement('div');
                node.className = 'tree-node';
                
                // Ê†πÊçÆÁÉ≠Â∫¶Ë∞ÉÊï¥ËäÇÁÇπÂ§ßÂ∞è
                const heat = heatMap.get(post.id) || 1;
                const size = 6 + Math.min(heat * 2, 8); // Âü∫Á°ÄÂ§ßÂ∞è6pxÔºåÁÉ≠Â∫¶Â¢ûÂä†ÊúÄÂ§ö8px
                node.style.width = size + 'px';
                node.style.height = size + 'px';
                
                node.style.left = (x - size/2) + 'px';
                node.style.top = (y - size/2) + 'px';
                node.style.backgroundColor = getPlatformColorForEvolution(post.platform);
                node.title = `${post.platform}: ${post.id} (ÁÉ≠Â∫¶: ${heat})`;
                
                // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
                node.addEventListener('mouseover', (e) => {
                    showTreeTooltip(e, post);
                });
                
                node.addEventListener('mouseout', () => {
                    hideTreeTooltip();
                });
                
                treeDiv.appendChild(node);
                
                // ËÆ∞ÂΩï‰∏ªÈ¢ò‰ΩçÁΩÆ
                if (!topicPositions.has(post.topicId)) {
                    topicPositions.set(post.topicId, { x, y });
                }
                
                // ÁªòÂà∂ËøûÊé•Á∫øÔºàÂ¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Â∏ñÂ≠êÔºâ
                if (index > 0) {
                    const prevPost = posts[index - 1];
                    const prevX = margin + (topicIds.indexOf(prevPost.topicId) * topicScale);
                    const prevY = height - margin - ((index - 1) * (height - 2 * margin) / (posts.length - 1));
                    
                    // Â¶ÇÊûú‰∏ªÈ¢òÁõ∏ÂêåÔºåÁªòÂà∂ÂûÇÁõ¥Á∫ø
                    if (post.topicId === prevPost.topicId) {
                        const link = document.createElement('div');
                        link.className = 'tree-link';
                        link.style.left = x + 'px';
                        link.style.top = prevY + 'px';
                        link.style.width = '1px';
                        link.style.height = (y - prevY) + 'px';
                        treeDiv.appendChild(link);
                    } else {
                        // Â¶ÇÊûú‰∏ªÈ¢ò‰∏çÂêåÔºåÁªòÂà∂ÊñúÁ∫ø
                        const link = document.createElement('div');
                        link.className = 'tree-link';
                        link.style.left = prevX + 'px';
                        link.style.top = prevY + 'px';
                        
                        const length = Math.sqrt(Math.pow(x - prevX, 2) + Math.pow(y - prevY, 2));
                        const angle = Math.atan2(y - prevY, x - prevX) * 180 / Math.PI;
                        
                        link.style.width = length + 'px';
                        link.style.transform = `rotate(${angle}deg)`;
                        treeDiv.appendChild(link);
                        
                        // Ê†áËÆ∞Âπ≥Âè∞ËΩ¨Êç¢
                        platformChanges.add(post.id);
                    }
                }
                

            });
        }
        
        // ÊòæÁ§∫ÊºîÂåñÊ†ëÂ∑•ÂÖ∑ÊèêÁ§∫
        function showTreeTooltip(event, post) {
            treeTooltip.style.opacity = '1';
            treeTooltip.style.left = (event.pageX + 10) + 'px';
            treeTooltip.style.top = (event.pageY - 10) + 'px';
            
            const heat = evolutionData.heatMap.get(post.id) || 1;
            
            treeTooltip.innerHTML = `
                <strong>${post.platform}</strong><br>
                Â∏ñÊñáID: ${post.id}<br>
                Êó∂Èó¥: ${post.time.toLocaleString()}<br>
                ‰∏ªÈ¢ò: ${post.topicId}<br>
                ÁÉ≠Â∫¶: ${heat}
            `;
        }
        
        // ÈöêËóèÊºîÂåñÊ†ëÂ∑•ÂÖ∑ÊèêÁ§∫
        function hideTreeTooltip() {
            treeTooltip.style.opacity = '0';
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅÂõæ‰æã
        function updateDynamicLegend() {
            // ÁªüËÆ°ÂΩìÂâçÊòæÁ§∫ÁöÑËäÇÁÇπÁ±ªÂûã
            const nodeTypeCounts = {
                user: filteredNodes.filter(n => n.type === 'user').length,
                post: filteredNodes.filter(n => n.type === 'post').length,
                platform: filteredNodes.filter(n => n.type === 'platform').length
            };
            
            // ÁªüËÆ°ÂΩìÂâçÊòæÁ§∫ÁöÑËæπÁ±ªÂûã
            const linkTypeCounts = {
                'user-post': filteredLinks.filter(l => l.type === 'user-post').length,
                'post-platform': filteredLinks.filter(l => l.type === 'post-platform').length,
                'post-spread': filteredLinks.filter(l => l.type === 'post-spread').length
            };
            
            // ÁªüËÆ°Âπ≥Âè∞ÂàÜÂ∏É
            const platformCounts = {};
            filteredNodes.filter(n => n.type === 'platform').forEach(node => {
                const platformName = extractPlatformFromPlatformId(node.id);
                platformCounts[platformName] = (platformCounts[platformName] || 0) + 1;
            });
            
            // Êõ¥Êñ∞Âõæ‰æã‰∏≠ÁöÑËÆ°Êï∞‰ø°ÊÅØ
            updateLegendCounts(nodeTypeCounts, linkTypeCounts, platformCounts);
        }
        
        // Êõ¥Êñ∞Âõæ‰æãËÆ°Êï∞
        function updateLegendCounts(nodeCounts, linkCounts, platformCounts) {
            // Êõ¥Êñ∞ËäÇÁÇπÁ±ªÂûãÂõæ‰æã
            const nodeLegendItems = document.querySelectorAll('.legend-item');
            nodeLegendItems.forEach(item => {
                const text = item.textContent;
                if (text.includes('Áî®Êà∑ËäÇÁÇπ')) {
                    const count = nodeCounts.user || 0;
                    item.innerHTML = item.innerHTML.replace(/Áî®Êà∑ËäÇÁÇπ.*/, `Áî®Êà∑ËäÇÁÇπ (Â∞è) - ${count}‰∏™`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('user');
                } else if (text.includes('Â∏ñÊñáËäÇÁÇπ')) {
                    const count = nodeCounts.post || 0;
                    item.innerHTML = item.innerHTML.replace(/Â∏ñÊñáËäÇÁÇπ.*/, `Â∏ñÊñáËäÇÁÇπ (‰∏≠) - ${count}‰∏™`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('post');
                } else if (text.includes('Âπ≥Âè∞ËäÇÁÇπ')) {
                    const count = nodeCounts.platform || 0;
                    item.innerHTML = item.innerHTML.replace(/Âπ≥Âè∞ËäÇÁÇπ.*/, `Âπ≥Âè∞ËäÇÁÇπ (Â§ß) - ${count}‰∏™`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightNodeType('platform');
                }
            });
            
            // Êõ¥Êñ∞ËæπÁ±ªÂûãÂõæ‰æã
            const linkLegendItems = document.querySelectorAll('.legend-item');
            linkLegendItems.forEach(item => {
                const text = item.textContent;
                if (text.includes('Áî®Êà∑-Â∏ñÊñáÂÖ≥Á≥ª')) {
                    const count = linkCounts['user-post'] || 0;
                    item.innerHTML = item.innerHTML.replace(/Áî®Êà∑-Â∏ñÊñáÂÖ≥Á≥ª.*/, `Áî®Êà∑-Â∏ñÊñáÂÖ≥Á≥ª - ${count}Êù°`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('user-post');
                } else if (text.includes('Â∏ñÊñá-Âπ≥Âè∞ÂÖ≥Á≥ª')) {
                    const count = linkCounts['post-platform'] || 0;
                    item.innerHTML = item.innerHTML.replace(/Â∏ñÊñá-Âπ≥Âè∞ÂÖ≥Á≥ª.*/, `Â∏ñÊñá-Âπ≥Âè∞ÂÖ≥Á≥ª - ${count}Êù°`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('post-platform');
                } else if (text.includes('‰º†Êí≠ÂÖ≥Á≥ª')) {
                    const count = linkCounts['post-spread'] || 0;
                    item.innerHTML = item.innerHTML.replace(/‰º†Êí≠ÂÖ≥Á≥ª.*/, `‰º†Êí≠ÂÖ≥Á≥ª - ${count}Êù°`);
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    item.style.cursor = 'pointer';
                    item.onclick = () => highlightLinkType('post-spread');
                }
            });
        }
        
        // È´ò‰∫ÆËäÇÁÇπÁ±ªÂûã
        function highlightNodeType(nodeType) {
            // ÈáçÁΩÆÊâÄÊúâËäÇÁÇπ
            svg.selectAll('circle').attr('opacity', 0.3);
            
            // È´ò‰∫ÆÊåáÂÆöÁ±ªÂûãÁöÑËäÇÁÇπ
            svg.selectAll('circle').filter(d => d.type === nodeType)
                .attr('opacity', 1)
                .attr('r', d => d.size * 1.5);
            
            // 3ÁßíÂêéÊÅ¢Â§ç
            setTimeout(() => {
                svg.selectAll('circle').attr('opacity', 1).attr('r', d => d.size);
            }, 3000);
        }
        
        // È´ò‰∫ÆËæπÁ±ªÂûã
        function highlightLinkType(linkType) {
            // ÈáçÁΩÆÊâÄÊúâËæπ
            svg.selectAll('line').attr('opacity', 0.1);
            
            // È´ò‰∫ÆÊåáÂÆöÁ±ªÂûãÁöÑËæπ
            svg.selectAll('line').filter(d => d.type === linkType)
                .attr('opacity', 0.8)
                .attr('stroke-width', d => d.width * 2);
            
            // 3ÁßíÂêéÊÅ¢Â§ç
            setTimeout(() => {
                svg.selectAll('line').attr('opacity', 0.6).attr('stroke-width', d => d.width);
            }, 3000);
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('weight-slider').addEventListener('input', function() {
                weightThreshold = parseFloat(this.value);
                document.getElementById('weight-value').textContent = weightThreshold.toFixed(2);
                applyFilters();
            });
            
            document.getElementById('show-users').addEventListener('change', function() {
                showUsers = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-posts').addEventListener('change', function() {
                showPosts = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-platforms').addEventListener('change', function() {
                showPlatforms = this.checked;
                applyFilters();
            });
            
            document.getElementById('show-labels').addEventListener('change', function() {
                showLabels = this.checked;
                updateVisualization();
            });
            
            document.getElementById('show-weights').addEventListener('change', function() {
                showWeights = this.checked;
                updateVisualization();
            });
            
            // Âä†ËΩΩÊï∞ÊçÆ
            loadData();
        });
    </script>
</body>
</html> 